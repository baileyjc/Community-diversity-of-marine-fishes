---
title: "Trait diversity analyses"
output: github_document
editor_options: 
  chunk_output_type: console
---
#### R Markdown

## Load packages
```{r, Load trait packages}
# Load the knitr package if not already loaded
library(knitr)

# Source the R Markdown file
knit("/Users/bailey/Documents/research/fish_biodiversity/src/collection/load_collection_data.Rmd", output = "/Users/bailey/Documents/research/fish_biodiversity/src/collection/load_collection_data.md")

library(picante)
library(phytools)
library(ggplot2)
library(viridis)
library(ggrepel)

# Define your custom colors
custom_colors <- c("Reference" = "black", "Ocean" = "#EE6363", "Mixed" = "#87CEFA", "Stratified" = "#6E8B3D")
```

## Functional Diversity MNTD, MPD, and PD
```{r, eval=F}
# Trait distance calculation
traits_dist <- gowdis(traits)
traits_clust <- hclust(traits_dist,"average")
traits_tree <- as.phylo(traits_clust)


#Mean pairwise differences
traits_sesmpd <- ses.mpd(presabs_lake, traits_dist, null.model = "taxa.labels", abundance.weighted = FALSE, runs = 999, iterations = 1000)

write.csv(traits_sesmpd, "/Users/bailey/Documents/research/fish_biodiversity/data/analyses/traits/traits_sesmpd.csv")


#Mean nearest taxon distance
traits_sesmntd <- ses.mntd(presabs_lake, traits_dist, null.model = "taxa.labels", abundance.weighted = FALSE, runs = 999, iterations = 1000)

write.csv(traits_sesmntd, "/Users/bailey/Documents/research/fish_biodiversity/data/analyses/traits/traits_sesmntd.csv")


#Faith's PD
traits_sespd <- ses.pd(presabs_lake, traits_tree, null.model = "taxa.labels", runs = 999, iterations = 1000, include.root = TRUE)

write.csv(traits_sespd, "/Users/bailey/Documents/research/fish_biodiversity/data/analyses/traits/traits_sespd.csv")


# Trait distance calculation
straits_dist <- gowdis(straits)
straits_clust <- hclust(straits_dist,"average")
straits_tree <- as.phylo(straits_clust)


#Mean pairwise differences
straits_sesmpd <- ses.mpd(surveyed_sites_lake, straits_dist, null.model = "taxa.labels", abundance.weighted = FALSE, runs = 999, iterations = 1000)

write.csv(straits_sesmpd, "/Users/bailey/Documents/research/fish_biodiversity/data/analyses/traits/straits_sesmpd.csv")


#Mean nearest taxon distance
straits_sesmntd <- ses.mntd(surveyed_sites_lake, straits_dist, null.model = "taxa.labels", abundance.weighted = FALSE, runs = 999, iterations = 1000)

write.csv(straits_sesmntd, "/Users/bailey/Documents/research/fish_biodiversity/data/analyses/traits/straits_sesmntd.csv")


#Faith's PD
straits_sespd <- ses.pd(surveyed_sites_lake, straits_tree, null.model = "taxa.labels", runs = 999, iterations = 1000, include.root = TRUE)

write.csv(straits_sespd, "/Users/bailey/Documents/research/fish_biodiversity/data/analyses/traits/straits_sespd.csv")
```

## Subset of traits Functional Diversity MNTD, MPD, and PD
```{r, eval=F}
# Trait distance calculation
keep <- c("BodyShapeI", "OperculumPresent", "Troph", "RepGuild1", "ParentalCare", "WaterPref", "DorsalSpinesMeann")
traits_subset <- traits[,keep]
traits_sub_dist <- gowdis(traits_subset)
traits_sub_clust <- hclust(traits_sub_dist,"average")
traits_sub_tree <- as.phylo(traits_sub_clust)

#Mean pairwise differences
traits_sub_sesmpd <- ses.mpd(presabs_lake, traits_sub_dist, null.model = "taxa.labels", abundance.weighted = FALSE, runs = 999, iterations = 1000)

#Mean nearest taxon distance
traits_sub_sesmntd <- ses.mntd(presabs_lake, traits_sub_dist, null.model = "taxa.labels", abundance.weighted = FALSE, runs = 999, iterations = 1000)

#Faith's PD
traits_sub_sespd <- ses.pd(presabs_lake, traits_sub_tree, null.model = "taxa.labels", runs = 999, iterations = 1000, include.root = TRUE)


# Trait distance calculation
straits_subset <- straits[,keep]
straits_sub_dist <- gowdis(straits_subset)
straits_sub_clust <- hclust(straits_sub_dist,"average")
straits_sub_tree <- as.phylo(straits_sub_clust)

#Mean pairwise differences
straits_sub_sesmpd <- ses.mpd(surveyed_sites_lake, straits_sub_dist, null.model = "taxa.labels", abundance.weighted = FALSE, runs = 999, iterations = 1000)

#Mean nearest taxon distance
straits_sub_sesmntd <- ses.mntd(surveyed_sites_lake, straits_sub_dist, null.model = "taxa.labels", abundance.weighted = FALSE, runs = 999, iterations = 1000)

#Faith's PD
straits_sub_sespd <- ses.pd(surveyed_sites_lake, straits_sub_tree, null.model = "taxa.labels", runs = 999, iterations = 1000, include.root = TRUE)
```

## Read in FD mpd, mntd, pd
- Read in Functional Diversity files and combine with env data
```{r, Read in FD files}
traits_sesmpd <- read.csv("/Users/bailey/Documents/research/fish_biodiversity/data/analyses/traits/traits_sesmpd.csv")

traits_sesmpd_env <- merge(traits_sesmpd, env, by = "X", sort = F)
traits_sesmpd_env$measure <- "traits_sesmpd"
traits_sesmpd_env$Stratification <- factor(traits_sesmpd_env$Stratification, levels = c("Reference", "Ocean", "Mixed", "Stratified"))


traits_sesmntd <- read.csv("/Users/bailey/Documents/research/fish_biodiversity/data/analyses/traits/traits_sesmntd.csv")

traits_sesmntd_env <- merge(traits_sesmntd, env, by = "X", sort = F)
traits_sesmntd_env$measure <- "traits_sesmntd"
traits_sesmntd_env$Stratification <- factor(traits_sesmntd_env$Stratification, levels = c("Reference", "Ocean", "Mixed", "Stratified"))


traits_sespd <- read.csv("/Users/bailey/Documents/research/fish_biodiversity/data/analyses/traits/traits_sespd.csv")

traits_sespd_env <- merge(traits_sespd, env, by = "X", sort = F)
traits_sespd_env$measure <- "traits_sespd"
traits_sespd_env$Stratification <- factor(traits_sespd_env$Stratification, levels = c("Reference", "Ocean", "Mixed", "Stratified"))


straits_sesmpd <- read.csv("/Users/bailey/Documents/research/fish_biodiversity/data/analyses/traits/straits_sesmpd.csv")

straits_sesmpd_env <- merge(straits_sesmpd, env, by = "X", sort = F)
straits_sesmpd_env$measure <- "straits_sesmpd"
straits_sesmpd_env$Stratification <- factor(straits_sesmpd_env$Stratification, levels = c("Ocean", "Mixed", "Stratified"))


straits_sesmntd <- read.csv("/Users/bailey/Documents/research/fish_biodiversity/data/analyses/traits/straits_sesmntd.csv")

straits_sesmntd_env <- merge(straits_sesmntd, env, by = "X", sort = F)
straits_sesmntd_env$measure <- "straits_sesmntd"
straits_sesmntd_env$Stratification <- factor(straits_sesmntd_env$Stratification, levels = c("Ocean", "Mixed", "Stratified"))


straits_sespd <-read.csv("/Users/bailey/Documents/research/fish_biodiversity/data/analyses/traits/straits_sespd.csv")

straits_sespd_env <- merge(straits_sespd, env, by = "X", sort = F)
straits_sespd_env$measure <- "straits_sespd"
straits_sespd_env$Stratification <- factor(straits_sespd_env$Stratification, levels = c("Ocean", "Mixed", "Stratified"))
```

## FR complete island Linear Models
```{r,}
FR_model <- lm(log(pd.obs) ~ volume_m3 + distance_to_ocean_mean_m + tidal_lag_time_minutes + max_depth + logArea, data = traits_sespd_env[c(1:2,4,5,12,17,21:22),])
summary(FR_model)
p_values <- summary(FR_model)$coefficients[, "Pr(>|t|)"]
adjusted_p_values <- p.adjust(p_values, method = "bonferroni")
anova(FR_model)
# Get R-squared value
r_squared <- summary(FR_model)$r.squared

# Get number of observations
n <- nrow(traits_sespd_env[c(1:2,4,5,12,17,21:22),])

# Get number of predictor variables (excluding intercept)
k <- length(coef(FR_model)) - 1  # Subtract 1 for the intercept

# Calculate Cohen's f^2
f_squared <- r_squared / (1 - r_squared) * ((n - k - 1) / k)

# Print the result
print(f_squared)


FR_model <- lm(pd.obs ~ temperature_median + salinity_median + oxygen_median + pH_median, data = traits_sespd_env[c(1:2,4,5,12,17,21:22),])
summary(FR_model)
p_values <- summary(FR_model)$coefficients[, "Pr(>|t|)"]
adjusted_p_values <- p.adjust(p_values, method = "bonferroni")
anova(FR_model)
# Get R-squared value
r_squared <- summary(FR_model)$r.squared

# Get number of observations
n <- nrow(traits_sespd_env[c(1:2,4,5,12,17,21:22),])

# Get number of predictor variables (excluding intercept)
k <- length(coef(FR_model)) - 1  # Subtract 1 for the intercept

# Calculate Cohen's f^2
f_squared <- r_squared / (1 - r_squared) * ((n - k - 1) / k)

# Print the result
print(f_squared)

FR_model <- lm(pd.obs ~ salinity_median, data = traits_sespd_env[c(1:2,4,5,12,17,21:22),])
summary(FR_model)
anova(FR_model)
plot(traits_sespd_env[c(1:2,4,5,12,17,21:22),3], traits_sespd_env[c(1:2,4,5,12,17,21:22),14])

# Island biogeography common relationships
fr_model <- lm(log(pd.obs) ~ logArea, data = traits_sespd_env[c(1:2,4,5,12,17,21:22),])
summary(fr_model)
anova(fr_model)

frz_model <- lm(pd.obs.z ~ logArea, data = traits_sespd_env[c(1:2,4,5,12,17,21:22),])
summary(frz_model)
anova(frz_model)

fr_model <- lm(log(pd.obs) ~ log(distance_to_ocean_mean_m), data = traits_sespd_env[c(1:2,4,5,12,17,21:22),])
summary(fr_model)
anova(fr_model)

fr_model <- lm(log(pd.obs) ~ log(max_depth), data = traits_sespd_env[c(1:2,4,5,12,17,21:22),])
summary(fr_model)
anova(fr_model)
```

## FR habitat island Linear Models
```{r,}
FR_model <- lm(log(pd.obs) ~ volume_m3_w_chemocline + distance_to_ocean_mean_m + tidal_lag_time_minutes + max_depth + logArea, data = traits_sespd_env[c(3,6,8,10,13:15,23),])
summary(FR_model)
p_values <- summary(FR_model)$coefficients[, "Pr(>|t|)"]
adjusted_p_values <- p.adjust(p_values, method = "bonferroni")
anova(FR_model)
# Get R-squared value
r_squared <- summary(FR_model)$r.squared

# Get number of observations
n <- nrow(traits_sespd_env[c(3,6,8,10,13:15,23),])

# Get number of predictor variables (excluding intercept)
k <- length(coef(FR_model)) - 1  # Subtract 1 for the intercept

# Calculate Cohen's f^2
f_squared <- r_squared / (1 - r_squared) * ((n - k - 1) / k)

# Print the result
print(f_squared)


FR_model <- lm(pd.obs ~ temperature_median + salinity_median + oxygen_median + pH_median, data = traits_sespd_env[c(3,6,8,10,13:15,23),])
summary(FR_model)
p_values <- summary(FR_model)$coefficients[, "Pr(>|t|)"]
adjusted_p_values <- p.adjust(p_values, method = "bonferroni")
anova(FR_model)
# Get R-squared value
r_squared <- summary(FR_model)$r.squared

# Get number of observations
n <- nrow(traits_sespd_env[c(3,6,8,10,13:15,23),])

# Get number of predictor variables (excluding intercept)
k <- length(coef(FR_model)) - 1  # Subtract 1 for the intercept

# Calculate Cohen's f^2
f_squared <- r_squared / (1 - r_squared) * ((n - k - 1) / k)

# Print the result
print(f_squared)

FR_model <- lm(pd.obs ~ pH_median, data = traits_sespd_env[c(3,6,8,10,13:15,23),])
summary(FR_model)
anova(FR_model)
plot(traits_sespd_env[c(3,6,8,10,13:15,23),3], traits_sespd_env[c(3,6,8,10,13:15,23),18])

# Island biogeography common relationships
fr_model <- lm(log(pd.obs) ~ logArea, data = traits_sespd_env[c(3,6,8,10,13:15,23),])
summary(fr_model)
anova(fr_model)

frz_model <- lm(pd.obs.z ~ logArea, data = traits_sespd_env[c(3,6,8,10,13:15,23),])
summary(frz_model)
anova(frz_model)

fr_model <- lm(log(pd.obs) ~ log(distance_to_ocean_mean_m), data = traits_sespd_env[c(3,6,8,10,13:15,23),])
summary(fr_model)
anova(fr_model)

fr_model <- lm(log(pd.obs) ~ log(max_depth), data = traits_sespd_env[c(3,6,8,10,13:15,23),])
summary(fr_model)
anova(fr_model)
```

## Plot functional richness for all sites with more than 1 species
```{r}
fr_plot <- ggplot(data = traits_sespd_env[-20,], mapping = aes(y = log(pd.obs), x = logArea, color = Stratification, fill = Stratification)) + 
  geom_point(stat = 'identity',
    size = 4,
    alpha = 1) + 
  geom_text_repel(label = traits_sespd_env[-20,1], size = 5, point.padding = 3) +
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  theme_bw() +
  theme(text = element_text(size = 22),legend.title =  element_text(size = 16), legend.text = element_text(size = 16),
    axis.text = element_text(size = 22, color = "black"),
    axis.line = element_line(color = "black"),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()) + 
  labs(x="Log Area (m"^"2"~")", y="FRic", colour = "Site type", fill = "Site type")
fr_plot <- fr_plot + guides(color = guide_legend(override.aes = list(label = "")))
fr_plot
ggsave("/Users/bailey/Documents/research/fish_biodiversity/figures/FD_plots/fr_plot_area.png", plot = fr_plot, width = 6, height = 4, units = "in")

fr_plot <- ggplot(data = traits_sespd_env[-20,], mapping = aes(y = log(pd.obs), x = log(distance_to_ocean_mean_m), color = Stratification, fill = Stratification)) + 
  geom_point(stat = 'identity',
    size = 4,
    alpha = 1) + 
  geom_text_repel(label = traits_sespd_env[-20,1], size = 5, point.padding = 3) +
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  theme_bw() +
  theme(text = element_text(size = 22),legend.title =  element_text(size = 16), legend.text = element_text(size = 16),
    axis.text = element_text(size = 22, color = "black"),
    axis.line = element_line(color = "black"),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()) + 
  labs(x="Log Isolation", y="FRic", colour = "Site type", fill = "Site type")
fr_plot <- fr_plot + guides(color = guide_legend(override.aes = list(label = "")))
fr_plot
ggsave("/Users/bailey/Documents/research/fish_biodiversity/figures/FD_plots/fr_plot_dist.png", plot = fr_plot, width = 6, height = 4, units = "in")

fr_plot <- ggplot(data = traits_sespd_env[-20,], mapping = aes(y = log(pd.obs), x = log(max_depth), color = Stratification, fill = Stratification)) + 
  geom_point(stat = 'identity',
    size = 4,
    alpha = 1) + 
  geom_text_repel(label = traits_sespd_env[-20,1], size = 5, point.padding = 3) +
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  theme_bw() +
  theme(text = element_text(size = 22),legend.title =  element_text(size = 16), legend.text = element_text(size = 16),
    axis.text = element_text(size = 22, color = "black"),
    axis.line = element_line(color = "black"),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()) + 
  labs(x="Log Age", y="FRic", colour = "Site type", fill = "Site type")
fr_plot <- fr_plot + guides(color = guide_legend(override.aes = list(label = "")))
fr_plot
ggsave("/Users/bailey/Documents/research/fish_biodiversity/figures/FD_plots/fr_plot_depth.png", plot = fr_plot, width = 6, height = 4, units = "in")
```

## Traits Z score vs p value plots
```{r, FD z score plots}
traits_sesmpd_plot <- ggplot(data = traits_sesmpd_env, mapping = aes(y = mpd.obs.p, x = mpd.obs.z, color = Stratification, fill = Stratification, label = X)) + 
  geom_point(stat = 'identity',
    size = 5,
    alpha = 1) + 
  geom_text_repel(label = traits_sesmpd_env[,1], size = 5, point.padding = 3) +
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  theme_bw() +
  theme(text = element_text(size = 22),legend.title =  element_text(size = 16), legend.text = element_text(size = 16),
    axis.text = element_text(size = 22, color = "black"),
    axis.line = element_line(color = "black"),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()) + 
  labs(x= "z-score", y= "p-value", colour = "Site type", fill = "Site type", tag = "A") +
  ylim(c(0,1)) +
  scale_x_continuous(breaks = c(-6, -4, -2, 0, 2), limits = c(-7,2)) +
  annotate('rect', ymin=0, ymax=1, xmin=-2, xmax=2, alpha = 0.3, fill='grey')
traits_sesmpd_plot <- traits_sesmpd_plot + guides(color = guide_legend(override.aes = list(label = "")))
traits_sesmpd_plot
ggsave("/Users/bailey/Documents/research/fish_biodiversity/figures/FD_plots/traits_sesmpd_plot_z.png", traits_sesmpd_plot, width = 6, height = 4, units = "in")

subset_traits_sesmpd_env <- subset(traits_sesmpd_env, Stratification == "Ocean")
ordered_subset_traits_sesmpd_env <- subset_traits_sesmpd_env[order(subset_traits_sesmpd_env$mpd.obs.z), ]
Q1 <- ordered_subset_traits_sesmpd_env[2,7]
Q3 <- ordered_subset_traits_sesmpd_env[5,7]
IQR1 <- Q3 - Q1
Q1 - 1.5*IQR1
Q3 + 1.5*IQR1
ordered_subset_traits_sesmpd_env$mpd.obs.z

subset_traits_sesmpd_env <- subset(traits_sesmpd_env, Stratification == "Mixed")
ordered_subset_traits_sesmpd_env <- subset_traits_sesmpd_env[order(subset_traits_sesmpd_env$mpd.obs.z), ]
Q1 <- ordered_subset_traits_sesmpd_env[3,7]
Q3 <- ordered_subset_traits_sesmpd_env[6,7]
IQR1 <- Q3 - Q1
Q1 - 1.5*IQR1
Q3 + 1.5*IQR1
ordered_subset_traits_sesmpd_env$mpd.obs.z

subset_traits_sesmpd_env <- subset(traits_sesmpd_env, Stratification == "Stratified")
ordered_subset_traits_sesmpd_env <- subset_traits_sesmpd_env[order(subset_traits_sesmpd_env$mpd.obs.z), ]
Q1 <- ordered_subset_traits_sesmpd_env[3,7]
Q3 <- ordered_subset_traits_sesmpd_env[6,7]
IQR1 <- Q3 - Q1
Q1 - 1.5*IQR1
Q3 + 1.5*IQR1
ordered_subset_traits_sesmpd_env$mpd.obs.z


traits_sesmntd_plot <- ggplot(data = traits_sesmntd_env, mapping = aes(y = mntd.obs.p, x = mntd.obs.z, color = Stratification, fill = Stratification)) + 
  geom_point(stat = 'identity',
    size = 5,
    alpha = 1) + 
  geom_text_repel(label = traits_sesmntd_env[,1], size = 5, point.padding = 3) +
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  theme_bw() +
  theme(text = element_text(size = 22), legend.title =  element_text(size = 16), legend.text = element_text(size = 16),
    axis.text = element_text(size = 22, color = "black"),
    axis.line = element_line(color = "black"),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()) + 
  labs(x= "z-score", y= "p-value", colour = "Site type", fill = "Site type", tag = "B") +
  ylim(c(0,1)) +
  scale_x_continuous(breaks = c(-6, -4, -2, 0, 2), limits = c(-7,2)) +
  annotate('rect', ymin=0, ymax=1, xmin=-2, xmax=2, alpha = 0.3, fill='grey')
traits_sesmntd_plot <- traits_sesmntd_plot + guides(color = guide_legend(override.aes = list(label = "")))
traits_sesmntd_plot
ggsave("/Users/bailey/Documents/research/fish_biodiversity/figures/FD_plots/traits_sesmntd_plot_z.png", traits_sesmntd_plot, width = 6, height = 4, units = "in")

subset_traits_sesmntd_env <- subset(traits_sesmntd_env, Stratification == "Ocean")
ordered_subset_traits_sesmntd_env <- subset_traits_sesmntd_env[order(subset_traits_sesmntd_env$mntd.obs.z), ]
Q1 <- ordered_subset_traits_sesmntd_env[2,7]
Q3 <- ordered_subset_traits_sesmntd_env[5,7]
IQR1 <- Q3 - Q1
Q1 - 1.5*IQR1
Q3 + 1.5*IQR1
ordered_subset_traits_sesmntd_env$mntd.obs.z

subset_traits_sesmntd_env <- subset(traits_sesmntd_env, Stratification == "Mixed")
ordered_subset_traits_sesmntd_env <- subset_traits_sesmntd_env[order(subset_traits_sesmntd_env$mntd.obs.z), ]
Q1 <- ordered_subset_traits_sesmntd_env[3,7]
Q3 <- ordered_subset_traits_sesmntd_env[6,7]
IQR1 <- Q3 - Q1
Q1 - 1.5*IQR1
Q3 + 1.5*IQR1
ordered_subset_traits_sesmntd_env$mntd.obs.z

subset_traits_sesmntd_env <- subset(traits_sesmntd_env, Stratification == "Stratified")
ordered_subset_traits_sesmntd_env <- subset_traits_sesmntd_env[order(subset_traits_sesmntd_env$mntd.obs.z), ]
Q1 <- ordered_subset_traits_sesmntd_env[3,7]
Q3 <- ordered_subset_traits_sesmntd_env[6,7]
IQR1 <- Q3 - Q1
Q1 - 1.5*IQR1
Q3 + 1.5*IQR1
ordered_subset_traits_sesmntd_env$mntd.obs.z


traits_sespd_plot <- ggplot(data = traits_sespd_env, mapping = aes(y = pd.obs.p, x = pd.obs.z, color = Stratification, fill = Stratification)) + 
  geom_point(stat = 'identity',
    size = 5,
    alpha = 1) + 
  geom_text_repel(label = traits_sespd_env[,1], size = 5, point.padding = 3) +
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  theme_bw() +
  theme(text = element_text(size = 22),legend.title =  element_text(size = 16), legend.text = element_text(size = 16),
    axis.text = element_text(size = 22, color = "black"),
    axis.line = element_line(color = "black"),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()) + 
  labs(x= "z-score", y= "p-value", colour = "Site type", fill = "Site type", tag = "C") +
  ylim(c(0,1)) +
  scale_x_continuous(breaks = c(-6, -4, -2, 0, 2), limits = c(-7,2)) + 
  annotate('rect', ymin=0, ymax=1, xmin=-2, xmax=2, alpha = 0.3, fill='grey')
traits_sespd_plot <- traits_sespd_plot + guides(color = guide_legend(override.aes = list(label = "")))
traits_sespd_plot
ggsave("/Users/bailey/Documents/research/fish_biodiversity/figures/FD_plots/traits_sespd_plot_z.png", traits_sespd_plot, width = 6, height = 4, units = "in")

subset_traits_sespd_env <- subset(traits_sespd_env, Stratification == "Ocean")
ordered_subset_traits_sespd_env <- subset_traits_sespd_env[order(subset_traits_sespd_env$pd.obs.z), ]
Q1 <- ordered_subset_traits_sespd_env[2,7]
Q3 <- ordered_subset_traits_sespd_env[5,7]
IQR1 <- Q3 - Q1
Q1 - 1.5*IQR1
Q3 + 1.5*IQR1
ordered_subset_traits_sespd_env$pd.obs.z

subset_traits_sespd_env <- subset(traits_sespd_env, Stratification == "Mixed")
ordered_subset_traits_sespd_env <- subset_traits_sespd_env[order(subset_traits_sespd_env$pd.obs.z), ]
Q1 <- ordered_subset_traits_sespd_env[3,7]
Q3 <- ordered_subset_traits_sespd_env[6,7]
IQR1 <- Q3 - Q1
Q1 - 1.5*IQR1
Q3 + 1.5*IQR1
ordered_subset_traits_sespd_env$pd.obs.z

subset_traits_sespd_env <- subset(traits_sespd_env, Stratification == "Stratified")
ordered_subset_traits_sespd_env <- subset_traits_sespd_env[order(subset_traits_sespd_env$pd.obs.z), ]
Q1 <- ordered_subset_traits_sespd_env[3,7]
Q3 <- ordered_subset_traits_sespd_env[6,7]
IQR1 <- Q3 - Q1
Q1 - 1.5*IQR1
Q3 + 1.5*IQR1
ordered_subset_traits_sespd_env$pd.obs.z
```

## Traits Z score vs obs value plots
```{r}
traits_sesmpd_plot <- ggplot(data = traits_sesmpd_env, mapping = aes(y = mpd.obs, x = mpd.obs.z, color = Stratification, fill = Stratification)) + 
  geom_point(stat = 'identity',
    size = 5,
    alpha = 1) + 
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  theme_bw() +
  theme(text = element_text(size = 22),legend.title =  element_text(size = 16), legend.text = element_text(size = 16),
    axis.text = element_text(size = 22, color = "black"),
    axis.line = element_line(color = "black"),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()) + 
  labs(y= "Observed MPD", x= "z-score", colour = "Site type", fill = "Site type") +
  # ylim(c(0,1)) +
  scale_x_continuous(breaks = c(-6,-4, -2, 0, 2), limits = c(-7,3)) +
  annotate('rect', ymin=0, ymax=1, xmin=-2, xmax=2, alpha = 0.3, fill='grey')
traits_sesmpd_plot <- traits_sesmpd_plot + guides(color = guide_legend(override.aes = list(label = "")))
traits_sesmpd_plot
ggsave("/Users/bailey/Documents/research/fish_biodiversity/figures/FD_plots/traits_sesmpd_plot_obs+z.png", traits_sesmpd_plot, width = 6, height = 4, units = "in")

traits_sesmntd_plot <- ggplot(data = traits_sesmntd_env, mapping = aes(y = mntd.obs, x = mntd.obs.z, color = Stratification, fill = Stratification)) + 
  geom_point(stat = 'identity',
    size = 5,
    alpha = 1) + 
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  theme_bw() +
  theme(text = element_text(size = 22),legend.title =  element_text(size = 16), legend.text = element_text(size = 16),
    axis.text = element_text(size = 22, color = "black"),
    axis.line = element_line(color = "black"),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()) + 
  labs(y= "Observed MNTD", x= "z-score", colour = "Site type", fill = "Site type") +
  # ylim(c(0,1)) +
  scale_x_continuous(breaks = c(-6,-4, -2, 0, 2), limits = c(-7,3)) +
  annotate('rect', ymin=0, ymax=1, xmin=-2, xmax=2, alpha = 0.3, fill='grey')
traits_sesmntd_plot <- traits_sesmntd_plot + guides(color = guide_legend(override.aes = list(label = "")))
traits_sesmntd_plot
ggsave("/Users/bailey/Documents/research/fish_biodiversity/figures/FD_plots/traits_sesmntd_plot_obs+z.png", traits_sesmntd_plot, width = 6, height = 4, units = "in")

traits_sespd_plot <- ggplot(data = traits_sespd_env, mapping = aes(y = pd.obs, x = pd.obs.z, color = Stratification, fill = Stratification)) + 
  geom_point(stat = 'identity',
    size = 5,
    alpha = 1) + 
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  theme_bw() +
  theme(text = element_text(size = 22),legend.title =  element_text(size = 16), legend.text = element_text(size = 16),
    axis.text = element_text(size = 22, color = "black"),
    axis.line = element_line(color = "black"),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()) + 
  labs(y= "Observed FD", x= "z-score", colour = "Site type", fill = "Site type") +
  ylim(c(0,6)) +
  scale_x_continuous(breaks = c(-6,-4, -2, 0, 2), limits = c(-7,3)) +
  annotate('rect', ymin=0, ymax=6, xmin=-2, xmax=2, alpha = 0.3, fill='grey')
traits_sespd_plot <- traits_sespd_plot + guides(color = guide_legend(override.aes = list(label = "")))
traits_sespd_plot
ggsave("/Users/bailey/Documents/research/fish_biodiversity/figures/FD_plots/traits_sespd_plot_obs+z.png", traits_sespd_plot, width = 6, height = 4, units = "in")
```

## Straits Z score vs p value plots
```{r}
straits_sesmpd_plot <- ggplot(data = straits_sesmpd_env, mapping = aes(y = mpd.obs.p, x = mpd.obs.z, color = Stratification, fill = Stratification)) + 
  geom_point(stat = 'identity',
    size = 4,
    alpha = 1) + 
  geom_text_repel(label = straits_sesmpd_env[,1], size = 5, point.padding = 3) +
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  theme_bw() +
  theme(text = element_text(size = 22),legend.title =  element_text(size = 16), legend.text = element_text(size = 16),
    axis.text = element_text(size = 22, color = "black"),
    axis.line = element_line(color = "black"),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()) + 
  labs(y= "p-value", x= "z-score", colour = "Site type", fill = "Site type", tag = "D") +
  ylim(c(0,1)) +
  scale_x_continuous(breaks = c(-6,-4, -2, 0, 2), limits = c(-7,3)) +
  annotate('rect', ymin=0, ymax=1, xmin=-2, xmax=2, alpha = 0.3, fill='grey')
straits_sesmpd_plot <- straits_sesmpd_plot + guides(color = guide_legend(override.aes = list(label = "")))
straits_sesmpd_plot
ggsave("/Users/bailey/Documents/research/fish_biodiversity/figures/FD_plots/straits_sesmpd_plot_z.png", straits_sesmpd_plot, width = 6, height = 4, units = "in")

subset_straits_sesmpd_env <- subset(straits_sesmpd_env, Stratification == "Ocean")
ordered_subset_straits_sesmpd_env <- subset_straits_sesmpd_env[order(subset_straits_sesmpd_env$mpd.obs.z), ]
Q1 <- ordered_subset_straits_sesmpd_env[2,7]
Q3 <- ordered_subset_straits_sesmpd_env[5,7]
IQR1 <- Q3 - Q1
Q1 - 1.5*IQR1
Q3 + 1.5*IQR1
ordered_subset_straits_sesmpd_env$mpd.obs.z

subset_straits_sesmpd_env <- subset(straits_sesmpd_env, Stratification == "Mixed")
ordered_subset_straits_sesmpd_env <- subset_straits_sesmpd_env[order(subset_straits_sesmpd_env$mpd.obs.z), ]
Q1 <- ordered_subset_straits_sesmpd_env[3,7]
Q3 <- ordered_subset_straits_sesmpd_env[6,7]
IQR1 <- Q3 - Q1
Q1 - 1.5*IQR1
Q3 + 1.5*IQR1
ordered_subset_straits_sesmpd_env$mpd.obs.z

subset_straits_sesmpd_env <- subset(straits_sesmpd_env, Stratification == "Stratified")
ordered_subset_straits_sesmpd_env <- subset_straits_sesmpd_env[order(subset_straits_sesmpd_env$mpd.obs.z), ]
Q1 <- ordered_subset_straits_sesmpd_env[3,7]
Q3 <- ordered_subset_straits_sesmpd_env[6,7]
IQR1 <- Q3 - Q1
Q1 - 1.5*IQR1
Q3 + 1.5*IQR1
ordered_subset_straits_sesmpd_env$mpd.obs.z


straits_sesmntd_plot <- ggplot(data = straits_sesmntd_env, mapping = aes(y = mntd.obs.p, x = mntd.obs.z, color = Stratification, fill = Stratification)) + 
  geom_point(stat = 'identity',
    size = 5,
    alpha = 1) + 
  geom_text_repel(label = straits_sesmntd_env[,1], size = 5, point.padding = 3) +
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  theme_bw() +
  theme(text = element_text(size = 22),legend.title =  element_text(size = 16), legend.text = element_text(size = 16),
    axis.text = element_text(size = 22, color = "black"),
    axis.line = element_line(color = "black"),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()) + 
  labs(y= "p-value", x= "z-score", colour = "Site type", fill = "Site type", tag = "E") +
  ylim(c(0,1)) +
  scale_x_continuous(breaks = c(-6,-4, -2, 0, 2), limits = c(-7,3)) +
  annotate('rect', ymin=0, ymax=1, xmin=-2, xmax=2, alpha = 0.3, fill='grey')
straits_sesmntd_plot <- straits_sesmntd_plot + guides(color = guide_legend(override.aes = list(label = "")))
straits_sesmntd_plot
ggsave("/Users/bailey/Documents/research/fish_biodiversity/figures/FD_plots/straits_sesmntd_plot_z.png", straits_sesmntd_plot, width = 6, height = 4, units = "in")

subset_straits_sesmntd_env <- subset(straits_sesmntd_env, Stratification == "Ocean")
ordered_subset_straits_sesmntd_env <- subset_straits_sesmntd_env[order(subset_straits_sesmntd_env$mntd.obs.z), ]
Q1 <- ordered_subset_straits_sesmntd_env[2,7]
Q3 <- ordered_subset_straits_sesmntd_env[5,7]
IQR1 <- Q3 - Q1
Q1 - 1.5*IQR1
Q3 + 1.5*IQR1
ordered_subset_straits_sesmntd_env$mntd.obs.z

subset_straits_sesmntd_env <- subset(straits_sesmntd_env, Stratification == "Mixed")
ordered_subset_straits_sesmntd_env <- subset_straits_sesmntd_env[order(subset_straits_sesmntd_env$mntd.obs.z), ]
Q1 <- ordered_subset_straits_sesmntd_env[3,7]
Q3 <- ordered_subset_straits_sesmntd_env[6,7]
IQR1 <- Q3 - Q1
Q1 - 1.5*IQR1
Q3 + 1.5*IQR1
ordered_subset_straits_sesmntd_env$mntd.obs.z

subset_straits_sesmntd_env <- subset(straits_sesmntd_env, Stratification == "Stratified")
ordered_subset_straits_sesmntd_env <- subset_straits_sesmntd_env[order(subset_straits_sesmntd_env$mntd.obs.z), ]
Q1 <- ordered_subset_straits_sesmntd_env[3,7]
Q3 <- ordered_subset_straits_sesmntd_env[6,7]
IQR1 <- Q3 - Q1
Q1 - 1.5*IQR1
Q3 + 1.5*IQR1
ordered_subset_straits_sesmntd_env$mntd.obs.z

straits_sespd_plot <- ggplot(data = straits_sespd_env, mapping = aes(y = pd.obs.p, x = pd.obs.z, color = Stratification, fill = Stratification)) + 
  geom_point(stat = 'identity',
    size = 5,
    alpha = 1) + 
  geom_text_repel(label = straits_sespd_env[,1], size = 5, point.padding = 3) +
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  theme_bw() +
  theme(text = element_text(size = 22),legend.title =  element_text(size = 16), legend.text = element_text(size = 16),
    axis.text = element_text(size = 22, color = "black"),
    axis.line = element_line(color = "black"),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()) + 
  labs(y= "p-value", x= "z-score", colour = "Site type", fill = "Site type", tag = "F") +
  ylim(c(0,1)) +
  scale_x_continuous(breaks = c(-6,-4, -2, 0, 2), limits = c(-7,3)) +
  annotate('rect', ymin=0, ymax=1, xmin=-2, xmax=2, alpha = 0.3, fill='grey')
straits_sespd_plot <- straits_sespd_plot + guides(color = guide_legend(override.aes = list(label = "")))
straits_sespd_plot
ggsave("/Users/bailey/Documents/research/fish_biodiversity/figures/FD_plots/straits_sespd_plot_z.png", straits_sespd_plot, width = 6, height = 4, units = "in")

subset_straits_sespd_env <- subset(straits_sespd_env, Stratification == "Ocean")
ordered_subset_straits_sespd_env <- subset_straits_sespd_env[order(subset_straits_sespd_env$pd.obs.z), ]
Q1 <- ordered_subset_straits_sespd_env[2,7]
Q3 <- ordered_subset_straits_sespd_env[5,7]
IQR1 <- Q3 - Q1
Q1 - 1.5*IQR1
Q3 + 1.5*IQR1
ordered_subset_straits_sespd_env$pd.obs.z

subset_straits_sespd_env <- subset(straits_sespd_env, Stratification == "Mixed")
ordered_subset_straits_sespd_env <- subset_straits_sespd_env[order(subset_straits_sespd_env$pd.obs.z), ]
Q1 <- ordered_subset_straits_sespd_env[3,7]
Q3 <- ordered_subset_straits_sespd_env[6,7]
IQR1 <- Q3 - Q1
Q1 - 1.5*IQR1
Q3 + 1.5*IQR1
ordered_subset_straits_sespd_env$pd.obs.z

subset_straits_sespd_env <- subset(straits_sespd_env, Stratification == "Stratified")
ordered_subset_straits_sespd_env <- subset_straits_sespd_env[order(subset_straits_sespd_env$pd.obs.z), ]
Q1 <- ordered_subset_straits_sespd_env[3,7]
Q3 <- ordered_subset_straits_sespd_env[6,7]
IQR1 <- Q3 - Q1
Q1 - 1.5*IQR1
Q3 + 1.5*IQR1
ordered_subset_straits_sespd_env$pd.obs.z
```

## Straits Z score vs obs value plots
```{r}
straits_sesmpd_plot <- ggplot(data = straits_sesmpd_env, mapping = aes(y = mpd.obs, x = mpd.obs.z, color = Stratification, fill = Stratification)) + 
  geom_point(stat = 'identity',
    size = 5,
    alpha = 1) + 
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  theme_bw() +
  theme(text = element_text(size = 22),legend.title =  element_text(size = 16), legend.text = element_text(size = 16),
    axis.text = element_text(size = 22, color = "black"),
    axis.line = element_line(color = "black"),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()) + 
  labs(y= "Observed MPD", x= "z-score", colour = "Site type", fill = "Site type") +
  ylim(c(0,1)) +
  scale_x_continuous(breaks = c(-6,-4, -2, 0, 2), limits = c(-7,3)) +
  annotate('rect', ymin=0, ymax=1, xmin=-2, xmax=2, alpha = 0.3, fill='grey')
straits_sesmpd_plot <- straits_sesmpd_plot + guides(color = guide_legend(override.aes = list(label = "")))
straits_sesmpd_plot
ggsave("/Users/bailey/Documents/research/fish_biodiversity/figures/FD_plots/straits_sesmpd_plot_obs+z.png", straits_sesmpd_plot, width = 6, height = 4, units = "in")

straits_sesmntd_plot <- ggplot(data = straits_sesmntd_env, mapping = aes(y = mntd.obs, x = mntd.obs.z, color = Stratification, fill = Stratification)) + 
  geom_point(stat = 'identity',
    size = 5,
    alpha = 1) + 
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  theme_bw() +
  theme(text = element_text(size = 22),legend.title =  element_text(size = 16), legend.text = element_text(size = 16),
    axis.text = element_text(size = 22, color = "black"),
    axis.line = element_line(color = "black"),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()) + 
  labs(y= "Observed MNTD", x= "z-score", colour = "Site type", fill = "Site type") +
  ylim(c(0,1)) +
  scale_x_continuous(breaks = c(-6,-4, -2, 0, 2), limits = c(-7,3)) +
  annotate('rect', ymin=0, ymax=1, xmin=-2, xmax=2, alpha = 0.3, fill='grey')
straits_sesmntd_plot <- straits_sesmntd_plot + guides(color = guide_legend(override.aes = list(label = "")))
straits_sesmntd_plot
ggsave("/Users/bailey/Documents/research/fish_biodiversity/figures/FD_plots/straits_sesmntd_plot_obs+z.png", straits_sesmntd_plot, width = 6, height = 4, units = "in")

straits_sespd_plot <- ggplot(data = straits_sespd_env, mapping = aes(y = pd.obs, x = pd.obs.z, color = Stratification, fill = Stratification)) + 
  geom_point(stat = 'identity',
    size = 5,
    alpha = 1) + 
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  theme_bw() +
  theme(text = element_text(size = 22),legend.title =  element_text(size = 16), legend.text = element_text(size = 16),
    axis.text = element_text(size = 22, color = "black"),
    axis.line = element_line(color = "black"),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()) + 
  labs(y= "Observed FD", x= "z-score", colour = "Site type", fill = "Site type") +
  ylim(c(0,6)) +
  scale_x_continuous(breaks = c(-6,-4, -2, 0, 2), limits = c(-7,3)) +
  annotate('rect', ymin=0, ymax=6, xmin=-2, xmax=2, alpha = 0.3, fill='grey')
straits_sespd_plot <- straits_sespd_plot + guides(color = guide_legend(override.aes = list(label = "")))
straits_sespd_plot
ggsave("/Users/bailey/Documents/research/fish_biodiversity/figures/FD_plots/straits_sespd_plot_obs+z.png", straits_sespd_plot, width = 6, height = 4, units = "in")
```

```{r, trait div session info}
sessionInfo()
```

## Regression of MPD
```{r, eval=F}
#MPD
man_traits_sesmpd_env_chem <- manova(cbind(temperature_median, salinity_median, oxygen_median, pH_median) ~ mpd.obs.z, data = traits_sesmpd_env)
summary.aov(man_traits_mpd_env_chem)

# traits_sesmpd_env_chem_model <- glmulti("mpd.obs.z", c("temperature_median", "salinity_median", "oxygen_median", "pH_median"), intercept = FALSE, level = 1, data = traits_sesmpd_env, method = "h")

man_traits_sesmpd_env_phys <- manova(cbind(surface_area_m2, volume_m3_w_chemocline, distance_to_ocean_min_m, tidal_efficiency, depth) ~ mpd.obs.z, data = traits_sesmpd_env)
summary.aov(man_traits_mpd_env_phys)

# traits_sesmpd_env_phys_model <- glmulti("mpd.obs.z", c("surface_area_m2", "volume_m3_w_chemocline", "distance_to_ocean_min_m", "tidal_efficiency", "depth", "logArea"), intercept = FALSE, level = 1, data = traits_sesmpd_env, method = "h")
# 
# traits_sesmpd_env_model <- glmulti("mpd.obs.z", c("surface_area_m2", "volume_m3_w_chemocline", "tidal_efficiency", "salinity_median", "oxygen_median", "pH_median"), intercept = FALSE, level = 1, data = traits_sesmpd_env, method = "h")

traits_sesmpd_env_model <- lm(mpd.obs.z ~ -1 + distance_to_ocean_min_m + tidal_efficiency + salinity_median + oxygen_median, data = traits_sesmpd_env)
summary(traits_mpd_env_model)
anova(traits_mpd_env_model)
```

## Plot MPD vs Oxygen Concentration
```{r, eval=F}
traits_sesmpd_oxygen_plot <- ggplot(data = traits_sesmpd_env, mapping = aes(x = oxygen_median, y = mpd.obs.z, color = Stratification, fill = Stratification, label = X)) + 
  geom_point(stat = 'identity',
    size = 5,
    alpha = 1) + 
  scale_color_viridis(alpha = 1, begin = 0.3, end = 0.75, discrete = T, option = "G") +
  scale_fill_viridis(alpha = 0.1, begin = 0.3, end = 0.75, discrete = T, option = "G") +
  theme_bw() +
  theme(text = element_text(size = 12),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    axis.line = element_line(color = "black")) +
  labs(x= "Median Oxygen Concentration (mg/L)", y= "sesMPD") +
  ylim(c(-6,3))
traits_sesmpd_oxygen_plot <- traits_sesmpd_oxygen_plot + geom_smooth(mapping = aes(x = oxygen_median, y = mpd.obs.z), method = lm, se = FALSE, inherit.aes = FALSE, color = 'black')
ggsave("traits_sesmpd_oxygen_plot.png", traits_sesmpd_oxygen_plot, width = 2, height = 2)
```

## Plot MPD vs Tidal Efficiency
```{r, eval=F}
traits_sesmpd_oxygen_plot <- ggplot(data = traits_sesmpd_env, mapping = aes(x = oxygen_median, y = mpd.obs.z, color = Stratification, fill = Stratification, label = X)) + 
  geom_point(stat = 'identity',
    size = 5,
    alpha = 1) + 
  scale_color_viridis(alpha = 1, begin = 0.3, end = 0.75, discrete = T, option = "G") +
  scale_fill_viridis(alpha = 0.1, begin = 0.3, end = 0.75, discrete = T, option = "G") +
  theme_bw() +
  theme(text = element_text(size = 12),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()) +
  theme(axis.line = element_line(color = "black")) +
  labs(x= "Median Oxygen Concentration (mg/L)", y= "sesMPD") +
  ylim(c(-6,3))
traits_sesmpd_oxygen_plot <- traits_sesmpd_oxygen_plot + geom_smooth(mapping = aes(x = oxygen_median, y = mpd.obs.z), method = lm, se = FALSE, inherit.aes = FALSE, color = 'black')
ggsave("traits_sesmpd_oxygen_plot.png", traits_sesmpd_oxygen_plot, width = 2, height = 2)
```

## Regression of MNTD
```{r, eval=F}
#MNTD
man_traits_sesmntd_env_chem <- manova(cbind(temperature_median, conductivity_median, salinity_median, oxygen_median, pH_median) ~ mntd.obs.z, data = traits_sesmntd_env)
summary.aov(man_traits_mntd_env_chem)

man_traits_sesmntd_env_phys <- manova(cbind(surface_area_m2, volume_m3_w_chemocline, distance_to_ocean_min_m, tidal_efficiency, depth) ~ mntd.obs.z, data = traits_sesmntd_env)
summary.aov(man_traits_mntd_env_phys)

traits_sesmntd_env_phys_model <- glmulti("mntd.obs.z", c("surface_area_m2", "volume_m3_w_chemocline", "distance_to_ocean_min_m", "tidal_efficiency", "depth", "logArea"), intercept = FALSE, level = 1, data = traits_sesmntd_env, method = "h")

traits_sesmntd_env_chem_model <- glmulti("mntd.obs.z", c("temperature_median", "salinity_median", "oxygen_median", "pH_median"), intercept = FALSE, level = 1, data = traits_sesmntd_env, method = "h")

traits_sesmntd_env_model <- glmulti("mntd.obs.z", c("surface_area_m2", "volume_m3_w_chemocline", "tidal_efficiency", "salinity_median", "oxygen_median", "pH_median"), intercept = FALSE, level = 1, data = traits_sesmntd_env, method = "h")

traits_sesmntd_env_model <- lm(mntd.obs.z ~ -1 + distance_to_ocean_min_m + salinity_median + oxygen_median, data = traits_sesmntd_env)
summary(traits_mntd_env_model)
anova(traits_mntd_env_model)
```

## Plot MNTD vs Oxygen Concentration
```{r, eval=F}
traits_sesmntd_oxygen_plot <- ggplot(data = traits_sesmntd_env, mapping = aes(x = oxygen_median, y = mntd.obs.z, color = Stratification, fill = Stratification, label = X)) + 
  geom_point(stat = 'identity',
    size = 5,
    alpha = 1) + 
  scale_color_viridis(alpha = 1, begin = 0.3, end = 0.75, discrete = T, option = "G") +
  scale_fill_viridis(alpha = 0.1, begin = 0.3, end = 0.75, discrete = T, option = "G") +
  theme_bw() +
  theme(text = element_text(size = 12),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()) +
  theme(axis.line = element_line(color = "black")) +
  labs(x= "Median Oxygen Concentration (mg/L)", y= "sesMNTD") +
  ylim(c(-6,2))
traits_sesmntd_oxygen_plot <- traits_sesmntd_oxygen_plot + geom_smooth(mapping = aes(x = oxygen_median, y = mntd.obs.z), method = lm, se = FALSE, inherit.aes = FALSE, color = 'black')
ggsave("traits_sesmntd_oxygen_plot.png", traits_sesmntd_oxygen_plot, width = 2, height = 2)
```

## Plot MNTD vs Tidal Efficiency
```{r, eval=F}
traits_sesmntd_oxygen_plot <- ggplot(data = traits_sesmntd_env, mapping = aes(x = oxygen_median, y = mntd.obs.z, color = Stratification, fill = Stratification, label = X)) + 
  geom_point(stat = 'identity',
    size = 5,
    alpha = 1) + 
  scale_color_viridis(alpha = 1, begin = 0.3, end = 0.75, discrete = T, option = "G") +
  scale_fill_viridis(alpha = 0.1, begin = 0.3, end = 0.75, discrete = T, option = "G") +
  theme_bw() +
  theme(text = element_text(size = 12),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()) +
  theme(axis.line = element_line(color = "black")) +
  labs(x= "Median Oxygen Concentration (mg/L)", y= "sesMNTD") +
  ylim(c(-6,2))
traits_sesmntd_oxygen_plot <- traits_sesmntd_oxygen_plot + geom_smooth(mapping = aes(x = oxygen_median, y = mntd.obs.z), method = lm, se = FALSE, inherit.aes = FALSE, color = 'black')
ggsave("traits_sesmntd_oxygen_plot.png", traits_sesmntd_oxygen_plot, width = 2, height = 2)
```

## Regression of PD
```{r, eval=F}
#PD
man_traits_sespd_env_chem <- manova(cbind(temperature_median, salinity_median, oxygen_median, pH_median) ~ pd.obs.z, data = traits_sespd_env)
summary.aov(man_traits_sespd_env_chem)

lm_traits_sespd_env_chem <- lm(pd.obs.z ~ oxygen_median, data = traits_sespd_env)
summary(lm_traits_sespd_env_chem)

traits_sespd_env_chem_model <- glmulti("pd.obs.z", c("temperature_median", "salinity_median", "oxygen_median", "pH_median"), intercept = FALSE, level = 1, data = traits_sespd_env, method = "h")

man_traits_sespd_env_phys <- manova(cbind(surface_area_m2, volume_m3_w_chemocline, distance_to_ocean_min_m, tidal_efficiency, depth, logArea) ~ pd.obs.z, data = traits_sespd_env)
summary.aov(man_traits_sespd_env_phys)

lm_traits_sespd_tidal <- lm(pd.obs.z ~ tidal_efficiency, data = traits_sespd_env)
summary(lm_traits_sespd_tidal)

traits_sespd_env_phys_model <- glmulti("pd.obs.z", c("surface_area_m2", "volume_m3_w_chemocline", "distance_to_ocean_min_m", "tidal_efficiency", "depth", "logArea"), intercept = FALSE, level = 1, data = traits_sespd_env, method = "h")

traits_sespd_env_model <- lm(pd.obs.z ~ -1 + distance_to_ocean_min_m + tidal_efficiency + oxygen_median + pH_median, data = traits_sespd_env)
summary(traits_pd_env_model)
anova(traits_pd_env_model)
```

## Plot PD vs Oxygen Concentration
```{r, eval=F}
traits_sespd_env_plot <- ggplot(data = traits_sespd_env, mapping = aes(x = oxygen_median, y = pd.obs.z, color = Stratification, fill = Stratification)) + 
  geom_point(stat = 'identity',
    size = 3,
    alpha = 1) + 
  scale_color_viridis(alpha = 1, begin = 0.3, end = 0.75, discrete = T, option = "G") +
  scale_fill_viridis(alpha = 0.5, begin = 0.3, end = 0.75, discrete = T, option = "G") +
  theme_bw() +
  theme(text = element_text(size = 18),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()) +
  theme(axis.line = element_line(color = "black")) +
  labs(x= "Env Variable", y= "sesFPD")
traits_sespd_env_plot + geom_smooth(mapping = aes(x = env_variable, y = pd.obs.z), method = lm, se = FALSE, inherit.aes = FALSE, color = 'black')
ggsave("traits_sespd_env_plot.png", traits_sespd_env_plot, width = 6, height = 4, units = "in")
```

## Plot PD vs Tidal Efficiency
```{r, eval=F}
traits_sespd_env_plot <- ggplot(data = traits_sespd_env, mapping = aes(x = oxygen_median, y = pd.obs.z, color = Stratification, fill = Stratification)) + 
  geom_point(stat = 'identity',
    size = 3,
    alpha = 1) + 
  scale_color_viridis(alpha = 1, begin = 0.3, end = 0.75, discrete = T, option = "G") +
  scale_fill_viridis(alpha = 0.5, begin = 0.3, end = 0.75, discrete = T, option = "G") +
  theme_bw() +
  theme(text = element_text(size = 18),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()) +
  theme(axis.line = element_line(color = "black")) +
  labs(x= "Env Variable", y= "sesFPD")
traits_sespd_env_plot + geom_smooth(mapping = aes(x = env_variable, y = pd.obs.z), method = lm, se = FALSE, inherit.aes = FALSE, color = 'black')
ggsave("traits_sespd_env_plot.png", traits_sespd_env_plot, width = 6, height = 4, units = "in")
```

## Plot z-scores and environmental variables
```{r, eval=F}
traits_phylo_ses_tidal_plot <- ggplot(data =  traits_phylo_ses_env, mapping = aes(x = tidal_efficiency, y = obs.z, color = Stratification, fill = Stratification)) + 
  geom_point(stat = 'identity',
    size = 5,
    alpha = 1) + 
  scale_color_viridis(alpha = 1, begin = 0.3, end = 0.75, discrete = T, option = "G") +
  scale_fill_viridis(alpha = 0.5, begin = 0.3, end = 0.75, discrete = T, option = "G") +
  theme_bw() +
  theme(text = element_text(size = 24),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black")) +
  labs(x= "Tidal Efficiency", y= "z-score") +
  ylim(c(-10,10))
traits_phylo_ses_tidal_plot <- traits_phylo_ses_tidal_plot + geom_smooth(mapping = aes(x = tidal_efficiency, y = obs.z), method = lm, se = FALSE, inherit.aes = FALSE, color = 'black')
traits_phylo_ses_tidal_plot <- traits_phylo_ses_tidal_plot + facet_wrap(ncol=3)
traits_phylo_ses_tidal_plot
ggsave("traits_phylo_ses_tidal_plot.png", traits_phylo_ses_tidal_plot, width = 2, height = 2)


traits_phylo_ses_oxygen_plot <- ggplot(data = traits_phylo_FD_all_env[-c(65:72,121:128,137:144,153:160),], mapping = aes(x = oxygen_median, y = obs.z, color = Environment)) + 
  geom_point(stat = 'identity',
    size = 8,
    alpha = 1) + 
  scale_color_viridis(alpha = 1, end = .95, discrete = TRUE, option = "H") +
  theme_bw() +
  theme(text = element_text(size = 24),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()) +
  theme(axis.line = element_line(color = "black")) +
  labs(x= "Median Oxygen Concentration (mg/L)", y= "z-score") +
  ylim(c(-10,10))
traits_phylo_ses_oxygen_plot <- traits_phylo_ses_oxygen_plot + geom_smooth(mapping = aes(x = oxygen_median, y = obs.z), method = lm, se = FALSE, inherit.aes = FALSE, color = 'black')
traits_phylo_ses_oxygen_plot <- traits_phylo_ses_oxygen_plot + facet_wrap(vars(Indice), ncol=2)
traits_phylo_ses_oxygen_plot
ggsave("traits_phylo_ses_oxygen_plot.png", traits_phylo_ses_oxygen_plot, width = 2, height = 2)
```

## Beta Diversity of Traits
```{r, eval=F}
traits_dist <- gowdis(main_traits)
traits_dist2 <- cailliez(traits_dist)
traits_dist2_pco <- dudi.pco(traits_dist2, scannf = FALSE, full = TRUE)
traits_pco_round <- round(traits_dist2_pco$li, .Machine$double.exponent)
traits_pco_complete <- traits_pco_round[, 1:2]
qual.FRic <- sum(traits_dist2_pco$eig[1:2]) / sum(traits_dist2_pco$eig)

# Do the following to order lakes by the circulation pattern, then delete env data
####https://pedrohbraga.github.io/StratificationPhylogenetics-Workshop/StratificationPhylogenetics-Workshop.html#between-assemblage-phylogenetic-structure####
presabs_env <- merge(pres_abs_by_lake, env_byLake, by = 'X')
presabs_env <- presabs_env[order(presabs_env$Environment),]
row.names(presabs_env) <- presabs_env$X
presabs_env_ordered <- presabs_env[,-c(1, 1692:1722)]

trait_beta <- functional.betapart.core.pairwise(presabs_env_ordered[-23,], traits_dist, parallel = TRUE)


trait_betap_jac <- functional.beta.pair(presabs_env_ordered[-23,], main_traits[,-c(1,5)], index.family="jaccard")

# Turnover matrix:
trait.jac.turn <- trait_betap_jac$beta.jtu %>% 
  as.matrix() %>% melt() %>% 
  ggplot() + geom_tile(aes(x = Var1, y = Var2, fill = value)) + # create the heatmap
  xlab("sites") + ylab("sites") + labs(fill = "Turnover") + # edit axis and legend titles
  scale_fill_viridis_c(option = "H", limits = range(0,1)) +
  theme(axis.text.x = element_text(angle = 90)) # rotates x axis labels

# Nestedness matrix:
trait.jac.nest <- trait_betap_jac$beta.jne %>% 
  as.matrix() %>% melt() %>% 
  ggplot() + geom_tile(aes(x = Var1, y = Var2, fill = value)) + # create the heatmap
  xlab("sites") + ylab("sites") + labs(fill = "Nestedness") + # edit axis and legend titles
    scale_fill_viridis_c(option = "H", limits = range(0,1)) +
  theme(axis.text.x = element_text(angle = 90)) # rotates x axis labels

# Nestedness matrix:
trait.jac <- trait_betap_jac$beta.jac %>% 
  as.matrix() %>% melt() %>% 
  ggplot() + geom_tile(aes(x = Var1, y = Var2, fill = value)) + # create the heatmap
  xlab("sites") + ylab("sites") + labs(fill = "Beta Diversity") + # edit axis and legend titles
    scale_fill_viridis_c(option = "H", limits = range(0,1)) +
  theme(axis.text.x = element_text(angle = 90)) # rotates x axis labels
trait.jac

# plot both heatmaps next to each other
gridExtra::grid.arrange(trait.jac.turn, trait.jac.nest, ncol = 2)
```

## Phylogenetic Signal
```{r, eval=F}
phylo_tree <- tree

check_diff <- setdiff(phylo_tree$tip.label, row.names(traits))
check_diff

check_diff <- setdiff(row.names(traits), phylo_tree$tip.label)
check_diff

# Get the tip labels of the phylogenetic tree
tip_labels <- phylo_tree$tip.label

# Order the rows of the trait matrix to match the tip labels
ordered_trait_matrix <- traits[tip_labels, ]

#Determine phylogenetic signal for each max length
ML <- ordered_trait_matrix$MaxLengthTL
ML_psig <- phylosig(phylo_tree, ML, method = "lambda",test=TRUE)
ML_psig

#Determine phylogenetic signal for each trophic level
TL <- ordered_trait_matrix$Troph
TL_psig <- phylosig(phylo_tree, TL, method = "lambda",test=TRUE)
TL_psig

#Determine phylogenetic signal for each depth min
DMin <- ordered_trait_matrix$DepthMin
DMin_psig <- phylosig(phylo_tree, DMin , method = "lambda",test=TRUE)
DMin_psig

#Determine phylogenetic signal for each depth max
DMax <- ordered_trait_matrix$DepthMax
DMax_psig <- phylosig(phylo_tree, DMax , method = "lambda",test=TRUE)
DMax_psig

#Determine phylogenetic signal for each temperature min
TMin <- ordered_trait_matrix$TempPrefMin
TMin_psig <- phylosig(phylo_tree, TMin , method = "lambda",test=TRUE)
TMin_psig

#Determine phylogenetic signal for each temperature max
TMax <- ordered_trait_matrix$TempPrefMax
TMax_psig <- phylosig(phylo_tree, TMax , method = "lambda",test=TRUE)
TMax_psig

#Determine phylogenetic signal for each dorsal spines
DS <- ordered_trait_matrix$DorsalSpinesMean
DS_psig <- phylosig(phylo_tree, DS , method = "lambda",test=TRUE)
DS_psig
```
