---
title: "Phylogenetic diversity analyses"
output: github_document
editor_options: 
  chunk_output_type: console
---
#### R Markdown

## Load packages
```{r, Load phylo packages}
# Load the knitr package if not already loaded
library(knitr)

# Source the R Markdown file
knit("/Users/bailey/Documents/research/fish_biodiversity/src/collection/load_collection_data.Rmd", output = "/Users/bailey/Documents/research/fish_biodiversity/src/collection/load_collection_data.md")

library(picante)
library(phytools)
library(ggplot2)
library(viridis)
library(ggrepel)

# Define your custom colors
custom_colors <- c("Reference" = "black", "Ocean" = "#EE6363", "Mixed" = "#87CEFA", "Stratified" = "#6E8B3D")
```

## Phylogenetic diversity MPD, MNTD, PD for all
```{r, PD with reference included, eval=F}
#Mean pairwise differences
phylo_sesmpd <- ses.mpd(presabs_lake, cophenetic(tree), null.model = "taxa.labels", abundance.weighted = FALSE, runs = 999, iterations = 1000)

write.csv(phylo_sesmpd, "/Users/bailey/Documents/research/fish_biodiversity/data/analyses/phylo/phylo_sesmpd.csv")


#Mean nearest taxon distance
phylo_sesmntd <- ses.mntd(presabs_lake, cophenetic(tree), null.model = "taxa.labels", abundance.weighted = FALSE, runs = 999, iterations = 1000)

write.csv(phylo_sesmntd, "/Users/bailey/Documents/research/fish_biodiversity/data/analyses/phylo/phylo_sesmntd.csv")


#Faiths PD
phylo_sespd <- ses.pd(presabs_lake, tree, null.model = "taxa.labels", runs = 999, iterations = 1000, include.root = TRUE)

write.csv(phylo_sespd, "/Users/bailey/Documents/research/fish_biodiversity/data/analyses/phylo/phylo_sespd.csv")
```

## Phylogenetic diversity MPD, MNTD, PD for sites
```{r, PD with sites only, eval=F}
#Mean pairwise differences
sphylo_sesmpd <- ses.mpd(surveyed_sites_lake, cophenetic(stree), null.model = "taxa.labels", abundance.weighted = FALSE, runs = 999, iterations = 1000)

write.csv(sphylo_sesmpd, "/Users/bailey/Documents/research/fish_biodiversity/data/analyses/phylo/sphylo_sesmpd.csv")


#Mean nearest taxon distance
sphylo_sesmntd <- ses.mntd(surveyed_sites_lake, cophenetic(stree), null.model = "taxa.labels", abundance.weighted = FALSE, runs = 999, iterations = 1000)

write.csv(sphylo_sesmntd, "/Users/bailey/Documents/research/fish_biodiversity/data/analyses/phylo/sphylo_sesmntd.csv")


#Faiths PD
sphylo_sespd <- ses.pd(surveyed_sites_lake, stree, null.model = "taxa.labels", runs = 999, iterations = 1000, include.root = TRUE)

write.csv(sphylo_sespd, "/Users/bailey/Documents/research/fish_biodiversity/data/analyses/phylo/sphylo_sespd.csv")
```

## Read in PD mpd, mntd, pd
- Read in Phylogenetic Diversity files and combine with env data
```{r, Read in PD files}
phylo_sesmpd <- read.csv("/Users/bailey/Documents/research/fish_biodiversity/data/analyses/phylo/phylo_sesmpd.csv")

phylo_sesmpd_env <- merge(phylo_sesmpd, env, by = "X", sort = F)
phylo_sesmpd_env$measure <- "phylo_sesmpd"
phylo_sesmpd_env$Stratification <- factor(phylo_sesmpd_env$Stratification, levels = c("Reference", "Ocean", "Mixed", "Stratified"))


phylo_sesmntd <- read.csv("/Users/bailey/Documents/research/fish_biodiversity/data/analyses/phylo/phylo_sesmntd.csv")

phylo_sesmntd_env <- merge(phylo_sesmntd, env, by = "X", sort = F)
phylo_sesmntd_env$measure <- "phylo_sesmntd"
phylo_sesmntd_env$Stratification <- factor(phylo_sesmntd_env$Stratification, levels = c("Reference", "Ocean", "Mixed", "Stratified"))


phylo_sespd <- read.csv("/Users/bailey/Documents/research/fish_biodiversity/data/analyses/phylo/phylo_sespd.csv")

phylo_sespd_env <- merge(phylo_sespd, env, by = "X", sort = F)
phylo_sespd_env$measure <- "phylo_sespd"
phylo_sespd_env$Stratification <- factor(phylo_sespd_env$Stratification, levels = c("Reference", "Ocean", "Mixed", "Stratified"))


sphylo_sesmpd <- read.csv("/Users/bailey/Documents/research/fish_biodiversity/data/analyses/phylo/sphylo_sesmpd.csv")

sphylo_sesmpd_env <- merge(sphylo_sesmpd, env[-20,], by = "X", sort = F)
sphylo_sesmpd_env$measure <- "sphylo_sesmpd"
sphylo_sesmpd_env$Stratification <- factor(sphylo_sesmpd_env$Stratification, levels = c("Ocean", "Mixed", "Stratified"))


sphylo_sesmntd <- read.csv("/Users/bailey/Documents/research/fish_biodiversity/data/analyses/phylo/sphylo_sesmntd.csv")

sphylo_sesmntd_env <- merge(sphylo_sesmntd, env[-20,], by = "X", sort = F)
sphylo_sesmntd_env$measure <- "sphylo_sesmntd"
sphylo_sesmntd_env$Stratification <- factor(sphylo_sesmntd_env$Stratification, levels = c("Ocean", "Mixed", "Stratified"))


sphylo_sespd <-read.csv("/Users/bailey/Documents/research/fish_biodiversity/data/analyses/phylo/sphylo_sespd.csv")

sphylo_sespd_env <- merge(sphylo_sespd, env[-20,], by = "X", sort = F)
sphylo_sespd_env$measure <- "sphylo_sespd"
sphylo_sespd_env$Stratification <- factor(sphylo_sespd_env$Stratification, levels = c("Ocean", "Mixed", "Stratified"))
```

## PR complete island Linear Models
```{r,}
PR_model <- lm(log(pd.obs) ~ volume_m3_w_chemocline + surface_area_m2 + distance_to_ocean_mean_m + tidal_lag_time_minutes + max_depth + logArea, data = phylo_sespd_env[c(1:2,4,5,12,17,21:22),])
summary(PR_model)
p_values <- summary(PR_model)$coefficients[, "Pr(>|t|)"]
adjusted_p_values <- p.adjust(p_values, method = "bonferroni")
anova(PR_model)
# Get R-squared value
r_squared <- summary(PR_model)$r.squared

# Get number of observations
n <- nrow(phylo_sespd_env[c(1:2,4,5,12,17,21:22),])

# Get number of predictor variables (excluding intercept)
k <- length(coef(PR_model)) - 1  # Subtract 1 for the intercept

# Calculate Cohen's f^2
f_squared <- r_squared / (1 - r_squared) * ((n - k - 1) / k)

# Print the result
print(f_squared)

PR_model <- lm(pd.obs ~ temperature_median + salinity_median + oxygen_median + pH_median, data = phylo_sespd_env[c(1:2,4,5,12,17,21:22),])
summary(PR_model)
p_values <- summary(PR_model)$coefficients[, "Pr(>|t|)"]
adjusted_p_values <- p.adjust(p_values, method = "bonferroni")
anova(PR_model)
# Get R-squared value
r_squared <- summary(PR_model)$r.squared

# Get number of observations
n <- nrow(phylo_sespd_env[c(1:2,4,5,12,17,21:22),])

# Get number of predictor variables (excluding intercept)
k <- length(coef(PR_model)) - 1  # Subtract 1 for the intercept

# Calculate Cohen's f^2
f_squared <- r_squared / (1 - r_squared) * ((n - k - 1) / k)

# Print the result
print(f_squared)

PR_model <- lm(pd.obs ~ salinity_median, data = phylo_sespd_env[c(1:2,4,5,12,17,21:22),])
summary(PR_model)
anova(PR_model)
plot(phylo_sespd_env[c(1:2,4,5,12,17,21:22),3], phylo_sespd_env[c(1:2,4,5,12,17,21:22),14])

# Island biogeography common relationships
pr_model <- lm(log(pd.obs) ~ logArea, data = phylo_sespd_env[c(1:2,4,5,12,17,21:22),])
summary(pr_model)
anova(pr_model)

prz_model <- lm(pd.obs.z ~ logArea, data = phylo_sespd_env[c(1:2,4,5,12,17,21:22),])
summary(prz_model)
anova(prz_model)

pr_model <- lm(log(pd.obs) ~ log(distance_to_ocean_mean_m), data = phylo_sespd_env[c(1:2,4,5,12,17,21:22),])
summary(pr_model)
anova(pr_model)

pr_model <- lm(log(pd.obs) ~ log(max_depth), data = phylo_sespd_env[c(1:2,4,5,12,17,21:22),])
summary(pr_model)
anova(pr_model)
```

## PR habitat island Linear Models
```{r,}
PR_model <- lm(log(pd.obs) ~ volume_m3_w_chemocline + distance_to_ocean_mean_m + tidal_lag_time_minutes + max_depth + logArea, data = phylo_sespd_env[c(3,6,8,10,13:15,23),])
summary(PR_model)
p_values <- summary(PR_model)$coefficients[, "Pr(>|t|)"]
adjusted_p_values <- p.adjust(p_values, method = "bonferroni")
anova(PR_model)
# Get R-squared value
r_squared <- summary(PR_model)$r.squared

# Get number of observations
n <- nrow(phylo_sespd_env[c(3,6,8,10,13:15,23),])

# Get number of predictor variables (excluding intercept)
k <- length(coef(PR_model)) - 1  # Subtract 1 for the intercept

# Calculate Cohen's f^2
f_squared <- r_squared / (1 - r_squared) * ((n - k - 1) / k)

# Print the result
print(f_squared)

PR_model <- lm(pd.obs ~ temperature_median + salinity_median + oxygen_median + pH_median, data = phylo_sespd_env[c(3,6,8,10,13:15,23),])
summary(PR_model)
p_values <- summary(PR_model)$coefficients[, "Pr(>|t|)"]
adjusted_p_values <- p.adjust(p_values, method = "bonferroni")
anova(PR_model)
# Get R-squared value
r_squared <- summary(PR_model)$r.squared

# Get number of observations
n <- nrow(phylo_sespd_env[c(3,6,8,10,13:15,23),])

# Get number of predictor variables (excluding intercept)
k <- length(coef(PR_model)) - 1  # Subtract 1 for the intercept

# Calculate Cohen's f^2
f_squared <- r_squared / (1 - r_squared) * ((n - k - 1) / k)

# Print the result
print(f_squared)

PR_model <- lm(pd.obs ~ pH_median, data = phylo_sespd_env[c(3,6,8,10,13:15,23),])
summary(PR_model)
anova(PR_model)
plot(phylo_sespd_env[c(3,6,8,10,13:15,23),3], phylo_sespd_env[c(3,6,8,10,13:15,23),18])

# Island biogeography common relationships
pr_model <- lm(log(pd.obs) ~ logArea, data = phylo_sespd_env[c(3,6,8,10,13:15,23),])
summary(pr_model)
anova(pr_model)

prz_model <- lm(pd.obs.z ~ logArea, data = phylo_sespd_env[c(3,6,8,10,13:15,23),])
summary(prz_model)
anova(prz_model)

pr_model <- lm(log(pd.obs) ~ log(distance_to_ocean_mean_m), data = phylo_sespd_env[c(3,6,8,10,13:15,23),])
summary(pr_model)
anova(pr_model)

pr_model <- lm(log(pd.obs) ~ log(max_depth), data = phylo_sespd_env[c(3,6,8,10,13:15,23),])
summary(pr_model)
anova(pr_model)
```

## Plot phylogenetic richness for all sites with more than 1 species
```{r}
pr_plot <- ggplot(data = phylo_sespd_env[-20,], mapping = aes(y = log(pd.obs), x = logArea, color = Stratification, fill = Stratification)) + 
  geom_point(stat = 'identity',
    size = 4,
    alpha = 1) + 
  geom_text_repel(label = phylo_sespd_env[-20,1], size = 5, point.padding = 3) +
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  theme_bw() +
  theme(text = element_text(size = 22), legend.title =  element_text(size = 16), legend.text = element_text(size = 16),
    axis.text = element_text(size = 22, color = "black"),
    axis.line = element_line(color = "black"),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()) +
  labs(x="Log Area (m"^"2"~")", y="Log PRic", colour = "Site type", fill = "Site type")
pr_plot <- pr_plot + guides(color = guide_legend(override.aes = list(label = "")))
pr_plot
ggsave("/Users/bailey/Documents/research/fish_biodiversity/figures/PD_plots/pr_plot_area.png", plot = pr_plot, width = 6, height = 4, units = "in")

pr_plot <- ggplot(data = phylo_sespd_env[-20,], mapping = aes(y = log(pd.obs), x = log(distance_to_ocean_mean_m), color = Stratification, fill = Stratification)) + 
  geom_point(stat = 'identity',
    size = 4,
    alpha = 1) + 
  geom_text_repel(label = phylo_sespd_env[-20,1], size = 5, point.padding = 3) +
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  theme_bw() +
  theme(text = element_text(size = 22), legend.title =  element_text(size = 16), legend.text = element_text(size = 16),
    axis.text = element_text(size = 22, color = "black"),
    axis.line = element_line(color = "black"),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()) +
  labs(x="Log Isolation", y="Log PRic", colour = "Site type", fill = "Site type")
pr_plot <- pr_plot + guides(color = guide_legend(override.aes = list(label = "")))
pr_plot
ggsave("/Users/bailey/Documents/research/fish_biodiversity/figures/PD_plots/pr_plot_dist.png", plot = pr_plot, width = 6, height = 4, units = "in")

pr_plot <- ggplot(data = phylo_sespd_env[-20,], mapping = aes(y = log(pd.obs), x = log(max_depth), color = Stratification, fill = Stratification)) + 
  geom_point(stat = 'identity',
    size = 4,
    alpha = 1) + 
  geom_text_repel(label = phylo_sespd_env[-20,1], size = 5, point.padding = 3) +
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  theme_bw() +
  theme(text = element_text(size = 22), legend.title =  element_text(size = 16), legend.text = element_text(size = 16),
    axis.text = element_text(size = 22, color = "black"),
    axis.line = element_line(color = "black"),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()) +
  labs(x="Log Age", y="Log PRic", colour = "Site type", fill = "Site type")
pr_plot <- pr_plot + guides(color = guide_legend(override.aes = list(label = "")))
pr_plot
ggsave("/Users/bailey/Documents/research/fish_biodiversity/figures/PD_plots/pr_plot_depth.png", plot = pr_plot, width = 6, height = 4, units = "in")
```

## Phylo Z score vs p value plots
```{r, create PD plots}
phylo_sesmpd_plot <- ggplot(data = phylo_sesmpd_env, mapping = aes(y = mpd.obs.p, x = mpd.obs.z, color = Stratification, fill = Stratification)) + 
  geom_point(stat = 'identity',
    size = 5,
    alpha = 1) + 
  geom_text_repel(label = phylo_sesmpd_env[,1], size = 5, point.padding = 3) +
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  theme_bw() +
  theme(text = element_text(size = 22), legend.title =  element_text(size = 16), legend.text = element_text(size = 16),
    axis.text = element_text(size = 22, color = "black"),
    axis.line = element_line(color = "black"),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()) + 
  labs(y= "p-value", x= "z-score", colour = "Site type", fill = "Site type", tag = "A") +
  ylim(c(0,1)) +
  scale_x_continuous(breaks = c(-6, -4, -2, 0, 2), limits = c(-7,2)) +
  annotate('rect', ymin=0, ymax=1, xmin=-2, xmax=2, alpha = 0.3, fill='grey')
phylo_sesmpd_plot <- phylo_sesmpd_plot + guides(color = guide_legend(override.aes = list(label = "")))
phylo_sesmpd_plot
ggsave("/Users/bailey/Documents/research/fish_biodiversity/figures/PD_plots/phylo_sesmpd_plot_z.png", phylo_sesmpd_plot, width = 6, height = 4, units = "in")

subset_phylo_sesmpd_env <- subset(phylo_sesmpd_env, Stratification == "Ocean")
ordered_subset_phylo_sesmpd_env <- subset_phylo_sesmpd_env[order(subset_phylo_sesmpd_env$mpd.obs.z), ]
Q1 <- ordered_subset_phylo_sesmpd_env[2,7]
Q3 <- ordered_subset_phylo_sesmpd_env[5,7]
IQR1 <- Q3 - Q1
Q1 - 1.5*IQR1
Q3 + 1.5*IQR1
ordered_subset_phylo_sesmpd_env$mpd.obs.z

subset_phylo_sesmpd_env <- subset(phylo_sesmpd_env, Stratification == "Mixed")
ordered_subset_phylo_sesmpd_env <- subset_phylo_sesmpd_env[order(subset_phylo_sesmpd_env$mpd.obs.z), ]
Q1 <- ordered_subset_phylo_sesmpd_env[3,7]
Q3 <- ordered_subset_phylo_sesmpd_env[6,7]
IQR1 <- Q3 - Q1
Q1 - 1.5*IQR1
Q3 + 1.5*IQR1
ordered_subset_phylo_sesmpd_env$mpd.obs.z

subset_phylo_sesmpd_env <- subset(phylo_sesmpd_env, Stratification == "Stratified")
ordered_subset_phylo_sesmpd_env <- subset_phylo_sesmpd_env[order(subset_phylo_sesmpd_env$mpd.obs.z), ]
Q1 <- ordered_subset_phylo_sesmpd_env[3,7]
Q3 <- ordered_subset_phylo_sesmpd_env[6,7]
IQR1 <- Q3 - Q1
Q1 - 1.5*IQR1
Q3 + 1.5*IQR1
ordered_subset_phylo_sesmpd_env$mpd.obs.z


phylo_sesmntd_plot <- ggplot(data = phylo_sesmntd_env, mapping = aes(y = mntd.obs.p, x = mntd.obs.z, color = Stratification, fill = Stratification)) + 
  geom_point(stat = 'identity',
    size = 5,
    alpha = 1) + 
  geom_text_repel(label = phylo_sesmntd_env[,1], size = 5, point.padding = 3) +
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  theme_bw() +
  theme(text = element_text(size = 22), legend.title =  element_text(size = 16), legend.text = element_text(size = 16),
    axis.text = element_text(size = 22, color = "black"),
    axis.line = element_line(color = "black"),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()) + 
  labs(y= "p-value", x= "z-score", colour = "Site type", fill = "Site type", tag = "B") +
  ylim(c(0,1))  +
  scale_x_continuous(breaks = c(-6, -4, -2, 0, 2), limits = c(-7,2)) +
  annotate('rect', ymin=0, ymax=1, xmin=-2, xmax=2, alpha = 0.3, fill='grey')
phylo_sesmntd_plot <- phylo_sesmntd_plot + guides(color = guide_legend(override.aes = list(label = "")))
phylo_sesmntd_plot
ggsave("/Users/bailey/Documents/research/fish_biodiversity/figures/PD_plots/phylo_sesmntd_plot_z.png", phylo_sesmntd_plot, width = 6, height = 4, units = "in")

subset_phylo_sesmntd_env <- subset(phylo_sesmntd_env, Stratification == "Ocean")
ordered_subset_phylo_sesmntd_env <- subset_phylo_sesmntd_env[order(subset_phylo_sesmntd_env$mntd.obs.z), ]
Q1 <- ordered_subset_phylo_sesmntd_env[2,7]
Q3 <- ordered_subset_phylo_sesmntd_env[5,7]
IQR1 <- Q3 - Q1
Q1 - 1.5*IQR1
Q3 + 1.5*IQR1
ordered_subset_phylo_sesmntd_env$mntd.obs.z

subset_phylo_sesmntd_env <- subset(phylo_sesmntd_env, Stratification == "Mixed")
ordered_subset_phylo_sesmntd_env <- subset_phylo_sesmntd_env[order(subset_phylo_sesmntd_env$mntd.obs.z), ]
Q1 <- ordered_subset_phylo_sesmntd_env[3,7]
Q3 <- ordered_subset_phylo_sesmntd_env[6,7]
IQR1 <- Q3 - Q1
Q1 - 1.5*IQR1
Q3 + 1.5*IQR1
ordered_subset_phylo_sesmntd_env$mntd.obs.z

subset_phylo_sesmntd_env <- subset(phylo_sesmntd_env, Stratification == "Stratified")
ordered_subset_phylo_sesmntd_env <- subset_phylo_sesmntd_env[order(subset_phylo_sesmntd_env$mntd.obs.z), ]
Q1 <- ordered_subset_phylo_sesmntd_env[3,7]
Q3 <- ordered_subset_phylo_sesmntd_env[6,7]
IQR1 <- Q3 - Q1
Q1 - 1.5*IQR1
Q3 + 1.5*IQR1
ordered_subset_phylo_sesmntd_env$mntd.obs.z


phylo_sespd_plot <- ggplot(data = phylo_sespd_env, mapping = aes(y = pd.obs.p, x = pd.obs.z, color = Stratification, fill = Stratification)) + 
  geom_point(stat = 'identity',
    size = 5,
    alpha = 1) + 
  geom_text_repel(label = phylo_sespd_env[,1], size = 5, point.padding = 3) +
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  theme_bw() +
  theme(text = element_text(size = 22), legend.title =  element_text(size = 16), legend.text = element_text(size = 16),
    axis.text = element_text(size = 22, color = "black"),
    axis.line = element_line(color = "black"),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()) + 
  labs(y= "p-value", x= "z-score", colour = "Site type", fill = "Site type", tag = "C") +
  ylim(c(0,1)) +
  scale_x_continuous(breaks = c(-6, -4, -2, 0, 2), limits = c(-7,2)) +
  annotate('rect', ymin=0, ymax=1, xmin=-2, xmax=2, alpha = 0.3, fill='grey')
phylo_sespd_plot <- phylo_sespd_plot + guides(color = guide_legend(override.aes = list(label = "")))
phylo_sespd_plot
ggsave("/Users/bailey/Documents/research/fish_biodiversity/figures/PD_plots/phylo_sespd_plot_z.png", phylo_sespd_plot, width = 6, height = 4, units = "in")

subset_phylo_sespd_env <- subset(phylo_sespd_env, Stratification == "Ocean")
ordered_subset_phylo_sespd_env <- subset_phylo_sespd_env[order(subset_phylo_sespd_env$pd.obs.z), ]
Q1 <- ordered_subset_phylo_sespd_env[2,7]
Q3 <- ordered_subset_phylo_sespd_env[5,7]
IQR1 <- Q3 - Q1
Q1 - 1.5*IQR1
Q3 + 1.5*IQR1
ordered_subset_phylo_sespd_env$pd.obs.z

subset_phylo_sespd_env <- subset(phylo_sespd_env, Stratification == "Mixed")
ordered_subset_phylo_sespd_env <- subset_phylo_sespd_env[order(subset_phylo_sespd_env$pd.obs.z), ]
Q1 <- ordered_subset_phylo_sespd_env[3,7]
Q3 <- ordered_subset_phylo_sespd_env[6,7]
IQR1 <- Q3 - Q1
Q1 - 1.5*IQR1
Q3 + 1.5*IQR1
ordered_subset_phylo_sespd_env$pd.obs.z

subset_phylo_sespd_env <- subset(phylo_sespd_env, Stratification == "Stratified")
ordered_subset_phylo_sespd_env <- subset_phylo_sespd_env[order(subset_phylo_sespd_env$pd.obs.z), ]
Q1 <- ordered_subset_phylo_sespd_env[3,7]
Q3 <- ordered_subset_phylo_sespd_env[6,7]
IQR1 <- Q3 - Q1
Q1 - 1.5*IQR1
Q3 + 1.5*IQR1
ordered_subset_phylo_sespd_env$pd.obs.z
```

## Phylo Z score vs obs value plots
```{r}
phylo_sesmpd_plot <- ggplot(data = phylo_sesmpd_env, mapping = aes(y = mpd.obs, x = mpd.obs.z, color = Stratification, fill = Stratification)) + 
  geom_point(stat = 'identity',
    size = 5,
    alpha = 1) + 
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  theme_bw() +
  theme(text = element_text(size = 22), legend.title =  element_text(size = 16), legend.text = element_text(size = 16),
    axis.text = element_text(size = 22, color = "black"),
    axis.line = element_line(color = "black"),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()) + 
  labs(y= "Observed MPD", x= "z-score", colour = "Site type", fill = "Site type") +
  ylim(c(0,300)) +
  scale_x_continuous(breaks = c(-6, -4, -2, 0, 2), limits = c(-7,3)) +
  annotate('rect', ymin=0, ymax=300, xmin=-2, xmax=2, alpha = 0.3, fill='grey')
phylo_sesmpd_plot <- phylo_sesmpd_plot + guides(color = guide_legend(override.aes = list(label = "")))
phylo_sesmpd_plot
ggsave("/Users/bailey/Documents/research/fish_biodiversity/figures/PD_plots/phylo_sesmpd_plot_obs+z.png", phylo_sesmpd_plot, width = 6, height = 4, units = "in")

phylo_sesmntd_plot <- ggplot(data = phylo_sesmntd_env, mapping = aes(y = mntd.obs, x = mntd.obs.z, color = Stratification, fill = Stratification)) + 
  geom_point(stat = 'identity',
    size = 5,
    alpha = 1) + 
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  theme_bw() +
  theme(text = element_text(size = 22), legend.title =  element_text(size = 16), legend.text = element_text(size = 16),
    axis.text = element_text(size = 22, color = "black"),
    axis.line = element_line(color = "black"),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()) + 
  labs(y= "Observed MNTD", x= "z-score", colour = "Site type", fill = "Site type") +
  ylim(c(0,250))  +
  scale_x_continuous(breaks = c(-6, -4, -2, 0, 2), limits = c(-7,3)) +
  annotate('rect', ymin=0, ymax=250, xmin=-2, xmax=2, alpha = 0.3, fill='grey')
phylo_sesmntd_plot <- phylo_sesmntd_plot + guides(color = guide_legend(override.aes = list(label = "")))
phylo_sesmntd_plot
ggsave("/Users/bailey/Documents/research/fish_biodiversity/figures/PD_plots/phylo_sesmntd_plot_obs+z.png", phylo_sesmntd_plot, width = 6, height = 4, units = "in")

phylo_sespd_plot <- ggplot(data = phylo_sespd_env, mapping = aes(y = pd.obs, x = pd.obs.z, color = Stratification, fill = Stratification)) + 
  geom_point(stat = 'identity',
    size = 5,
    alpha = 1) + 
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  theme_bw() +
  theme(text = element_text(size = 22), legend.title =  element_text(size = 16), legend.text = element_text(size = 16),
    axis.text = element_text(size = 22, color = "black"),
    axis.line = element_line(color = "black"),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()) + 
  labs(y= "Observed PD", x = "z-score", colour = "Site type", fill = "Site type") +
  ylim(c(0,6000)) +
  scale_x_continuous(breaks = c(-6, -4, -2, 0, 2), limits = c(-7,3)) +
  annotate('rect', ymin=0, ymax=6000, xmin=-2, xmax=2, alpha = 0.3, fill='grey')
phylo_sespd_plot <- phylo_sespd_plot + guides(color = guide_legend(override.aes = list(label = "")))
phylo_sespd_plot
ggsave("/Users/bailey/Documents/research/fish_biodiversity/figures/PD_plots/phylo_sespd_plot_obs+z.png", phylo_sespd_plot, width = 6, height = 4, units = "in")
```

## Sphylo Z score vs p value plots
```{r}
sphylo_sesmpd_plot <- ggplot(data = sphylo_sesmpd_env, mapping = aes(y = mpd.obs.p, x = mpd.obs.z, color = Stratification, fill = Stratification)) + 
  geom_point(stat = 'identity',
    size = 5,
    alpha = 1) + 
  geom_text_repel(label = sphylo_sesmpd_env[,1], size = 5, point.padding = 3) +
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  theme_bw() +
  theme(text = element_text(size = 22), legend.title =  element_text(size = 16), legend.text = element_text(size = 16),
    axis.text = element_text(size = 22, color = "black"),
    axis.line = element_line(color = "black"),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()) + 
  labs(y= "p-value", x= "z-score", colour = "Site type", fill = "Site type", tag = "D") +
  ylim(c(0,1)) +
  scale_x_continuous(breaks = c(-6, -4, -2, 0, 2), limits = c(-7,3)) +
  annotate('rect', ymin=-0, ymax=1, xmin=-2, xmax=2, alpha = 0.3, fill='grey')
sphylo_sesmpd_plot <- sphylo_sesmpd_plot + guides(color = guide_legend(override.aes = list(label = "")))
sphylo_sesmpd_plot
ggsave("/Users/bailey/Documents/research/fish_biodiversity/figures/PD_plots/sphylo_sesmpd_plot_z.png", sphylo_sesmpd_plot, width = 6, height = 4, units = "in")

subset_sphylo_sesmpd_env <- subset(sphylo_sesmpd_env, Stratification == "Ocean")
ordered_subset_sphylo_sesmpd_env <- subset_sphylo_sesmpd_env[order(subset_sphylo_sesmpd_env$mpd.obs.z), ]
Q1 <- ordered_subset_sphylo_sesmpd_env[2,7]
Q3 <- ordered_subset_sphylo_sesmpd_env[5,7]
IQR1 <- Q3 - Q1
Q1 - 1.5*IQR1
Q3 + 1.5*IQR1
ordered_subset_sphylo_sesmpd_env$mpd.obs.z

subset_sphylo_sesmpd_env <- subset(sphylo_sesmpd_env, Stratification == "Mixed")
ordered_subset_sphylo_sesmpd_env <- subset_sphylo_sesmpd_env[order(subset_sphylo_sesmpd_env$mpd.obs.z), ]
Q1 <- ordered_subset_sphylo_sesmpd_env[3,7]
Q3 <- ordered_subset_sphylo_sesmpd_env[6,7]
IQR1 <- Q3 - Q1
Q1 - 1.5*IQR1
Q3 + 1.5*IQR1
ordered_subset_sphylo_sesmpd_env$mpd.obs.z

subset_sphylo_sesmpd_env <- subset(sphylo_sesmpd_env, Stratification == "Stratified")
ordered_subset_sphylo_sesmpd_env <- subset_sphylo_sesmpd_env[order(subset_sphylo_sesmpd_env$mpd.obs.z), ]
Q1 <- ordered_subset_sphylo_sesmpd_env[3,7]
Q3 <- ordered_subset_sphylo_sesmpd_env[6,7]
IQR1 <- Q3 - Q1
Q1 - 1.5*IQR1
Q3 + 1.5*IQR1
ordered_subset_sphylo_sesmpd_env$mpd.obs.z


sphylo_sesmntd_plot <- ggplot(data = sphylo_sesmntd_env, mapping = aes(y = mntd.obs.p, x = mntd.obs.z, color = Stratification, fill = Stratification)) + 
  geom_point(stat = 'identity',
    size = 5,
    alpha = 1) + 
  geom_text_repel(label = sphylo_sesmntd_env[,1], size = 5, point.padding = 3) +
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  theme_bw() +
  theme(text = element_text(size = 22), legend.title =  element_text(size = 16), legend.text = element_text(size = 16),
    axis.text = element_text(size = 22, color = "black"),
    axis.line = element_line(color = "black"),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()) + 
  labs(y= "p-value", x= "z-score", colour = "Site type", fill = "Site type", tag = "E") +
  ylim(c(0,1))  +
  scale_x_continuous(breaks = c(-6, -4, -2, 0, 2), limits = c(-7,3)) +
  annotate('rect', ymin=0, ymax=1, xmin=-2, xmax=2, alpha = 0.3, fill='grey')
sphylo_sesmntd_plot <- sphylo_sesmntd_plot + guides(color = guide_legend(override.aes = list(label = "")))
sphylo_sesmntd_plot
ggsave("/Users/bailey/Documents/research/fish_biodiversity/figures/PD_plots/sphylo_sesmntd_plot_z.png", sphylo_sesmntd_plot, width = 6, height = 4, units = "in")

subset_sphylo_sesmntd_env <- subset(sphylo_sesmntd_env, Stratification == "Ocean")
ordered_subset_sphylo_sesmntd_env <- subset_sphylo_sesmntd_env[order(subset_sphylo_sesmntd_env$mntd.obs.z), ]
Q1 <- ordered_subset_sphylo_sesmntd_env[2,7]
Q3 <- ordered_subset_sphylo_sesmntd_env[5,7]
IQR1 <- Q3 - Q1
Q1 - 1.5*IQR1
Q3 + 1.5*IQR1
ordered_subset_sphylo_sesmntd_env$mntd.obs.z

subset_sphylo_sesmntd_env <- subset(sphylo_sesmntd_env, Stratification == "Mixed")
ordered_subset_sphylo_sesmntd_env <- subset_sphylo_sesmntd_env[order(subset_sphylo_sesmntd_env$mntd.obs.z), ]
Q1 <- ordered_subset_sphylo_sesmntd_env[3,7]
Q3 <- ordered_subset_sphylo_sesmntd_env[6,7]
IQR1 <- Q3 - Q1
Q1 - 1.5*IQR1
Q3 + 1.5*IQR1
ordered_subset_sphylo_sesmntd_env$mntd.obs.z

subset_sphylo_sesmntd_env <- subset(sphylo_sesmntd_env, Stratification == "Stratified")
ordered_subset_sphylo_sesmntd_env <- subset_sphylo_sesmntd_env[order(subset_sphylo_sesmntd_env$mntd.obs.z), ]
Q1 <- ordered_subset_sphylo_sesmntd_env[3,7]
Q3 <- ordered_subset_sphylo_sesmntd_env[6,7]
IQR1 <- Q3 - Q1
Q1 - 1.5*IQR1
Q3 + 1.5*IQR1
ordered_subset_sphylo_sesmntd_env$mntd.obs.z


sphylo_sespd_plot <- ggplot(data = sphylo_sespd_env, mapping = aes(y = pd.obs.p, x = pd.obs.z, color = Stratification, fill = Stratification)) + 
  geom_point(stat = 'identity',
    size = 5,
    alpha = 1) + 
  geom_text_repel(label = sphylo_sespd_env[,1], size = 5, point.padding = 3) +
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  theme_bw() +
  theme(text = element_text(size = 22), legend.title =  element_text(size = 16), legend.text = element_text(size = 16),
    axis.text = element_text(size = 22, color = "black"),
    axis.line = element_line(color = "black"),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()) + 
  labs(y= "p-value", x = "z-score", colour = "Site type", fill = "Site type", tag = "F") +
  ylim(c(0,1)) +
  scale_x_continuous(breaks = c(-6, -4, -2, 0, 2), limits = c(-7,3)) +
  annotate('rect', ymin=0, ymax=1, xmin=-2, xmax=2, alpha = 0.3, fill='grey')
sphylo_sespd_plot <- sphylo_sespd_plot + guides(color = guide_legend(override.aes = list(label = "")))
sphylo_sespd_plot
ggsave("/Users/bailey/Documents/research/fish_biodiversity/figures/PD_plots/sphylo_sespd_plot_z.png", sphylo_sespd_plot, width = 6, height = 4, units = "in")

subset_sphylo_sespd_env <- subset(sphylo_sespd_env, Stratification == "Ocean")
ordered_subset_sphylo_sespd_env <- subset_sphylo_sespd_env[order(subset_sphylo_sespd_env$pd.obs.z), ]
Q1 <- ordered_subset_sphylo_sespd_env[2,7]
Q3 <- ordered_subset_sphylo_sespd_env[5,7]
IQR1 <- Q3 - Q1
Q1 - 1.5*IQR1
Q3 + 1.5*IQR1
ordered_subset_sphylo_sespd_env$pd.obs.z

subset_sphylo_sespd_env <- subset(sphylo_sespd_env, Stratification == "Mixed")
ordered_subset_sphylo_sespd_env <- subset_sphylo_sespd_env[order(subset_sphylo_sespd_env$pd.obs.z), ]
Q1 <- ordered_subset_sphylo_sespd_env[3,7]
Q3 <- ordered_subset_sphylo_sespd_env[6,7]
IQR1 <- Q3 - Q1
Q1 - 1.5*IQR1
Q3 + 1.5*IQR1
ordered_subset_sphylo_sespd_env$pd.obs.z

subset_sphylo_sespd_env <- subset(sphylo_sespd_env, Stratification == "Stratified")
ordered_subset_sphylo_sespd_env <- subset_sphylo_sespd_env[order(subset_sphylo_sespd_env$pd.obs.z), ]
Q1 <- ordered_subset_sphylo_sespd_env[3,7]
Q3 <- ordered_subset_sphylo_sespd_env[6,7]
IQR1 <- Q3 - Q1
Q1 - 1.5*IQR1
Q3 + 1.5*IQR1
ordered_subset_sphylo_sespd_env$pd.obs.z
```

## Sphylo Z score vs obs value plots
```{r}
sphylo_sesmpd_plot <- ggplot(data = sphylo_sesmpd_env, mapping = aes(y = mpd.obs, x = mpd.obs.z, color = Stratification, fill = Stratification)) + 
  geom_point(stat = 'identity',
    size = 5,
    alpha = 1) + 
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  theme_bw() +
  theme(text = element_text(size = 22), legend.title =  element_text(size = 16), legend.text = element_text(size = 16),
    axis.text = element_text(size = 22, color = "black"),
    axis.line = element_line(color = "black"),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()) + 
  labs(y= "Observed MPD", x= "z-score", colour = "Site type", fill = "Site type") +
  ylim(c(0,250)) +
  scale_x_continuous(breaks = c(-6, -4, -2, 0, 2), limits = c(-7,3)) +
  annotate('rect', ymin=0, ymax=250, xmin=-2, xmax=2, alpha = 0.3, fill='grey')
sphylo_sesmpd_plot <- sphylo_sesmpd_plot + guides(color = guide_legend(override.aes = list(label = "")))
sphylo_sesmpd_plot
ggsave("/Users/bailey/Documents/research/fish_biodiversity/figures/PD_plots/sphylo_sesmpd_plot_obs+z.png", sphylo_sesmpd_plot, width = 6, height = 4, units = "in")

sphylo_sesmntd_plot <- ggplot(data = sphylo_sesmntd_env, mapping = aes(y = mntd.obs, x = mntd.obs.z, color = Stratification, fill = Stratification)) + 
  geom_point(stat = 'identity',
    size = 5,
    alpha = 1) + 
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  theme_bw() +
  theme(text = element_text(size = 22), legend.title =  element_text(size = 16), legend.text = element_text(size = 16),
    axis.text = element_text(size = 22, color = "black"),
    axis.line = element_line(color = "black"),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()) + 
  labs(y= "Observed MNTD", x= "z-score", colour = "Site type", fill = "Site type") +
  ylim(c(0,250))  +
  scale_x_continuous(breaks = c(-6, -4, -2, 0, 2), limits = c(-7,3)) +
  annotate('rect', ymin=0, ymax=250, xmin=-2, xmax=2, alpha = 0.3, fill='grey')
sphylo_sesmntd_plot <- sphylo_sesmntd_plot + guides(color = guide_legend(override.aes = list(label = "")))
sphylo_sesmntd_plot
ggsave("/Users/bailey/Documents/research/fish_biodiversity/figures/PD_plots/sphylo_sesmntd_plot_obs+z.png", sphylo_sesmntd_plot, width = 6, height = 4, units = "in")

sphylo_sespd_plot <- ggplot(data = sphylo_sespd_env, mapping = aes(y = pd.obs, x = pd.obs.z, color = Stratification, fill = Stratification)) + 
  geom_point(stat = 'identity',
    size = 5,
    alpha = 1) + 
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  theme_bw() +
  theme(text = element_text(size = 22), legend.title =  element_text(size = 16), legend.text = element_text(size = 16),
    axis.text = element_text(size = 22, color = "black"),
    axis.line = element_line(color = "black"),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()) + 
  labs(y= "Observed PD", x = "z-score", colour = "Site type", fill = "Site type") +
  ylim(c(0,6000)) +
  scale_x_continuous(breaks = c(-6, -4, -2, 0, 2), limits = c(-7,3)) +
  annotate('rect', ymin=0, ymax=6000, xmin=-2, xmax=2, alpha = 0.3, fill='grey')
sphylo_sespd_plot <- sphylo_sespd_plot + guides(color = guide_legend(override.aes = list(label = "")))
sphylo_sespd_plot
ggsave("/Users/bailey/Documents/research/fish_biodiversity/figures/PD_plots/sphylo_sespd_plot_obs+z.png", sphylo_sespd_plot, width = 6, height = 4, units = "in")
```

```{r, phylo div analyses session info}
sessionInfo()
```

## Regression of MPD
```{r, eval=F}
#MPD
phylo_sesmpd_env_chem <- phylo_sesmpd_env[-c(9, 16, 18, 20),]

man_phylo_sesmpd_env_chem <- manova(cbind(temperature_median, salinity_median, oxygen_median, pH_median) ~ mpd.obs.z, data = phylo_sesmpd_env_chem)
summary.aov(man_phylo_sesmpd_env_chem)

lm_phylo_sesmpd_env_chem <- lm(mpd.obs.z ~ temperature_median * salinity_median * oxygen_median * pH_median, data = phylo_sesmpd_env_chem)
summary(lm_phylo_sesmpd_env_chem)

step( object = lm_phylo_sesmpd_env_chem,     # start at the full model
       direction = "backward"   # allow it remove predictors but not add them
)

phylo_sesmpd_env_chem_model <- glmulti("mpd.obs.z", c("temperature_median", "salinity_median", "oxygen_median", "pH_median"), intercept = FALSE, level = 1, data = phylo_sesmpd_env, method = "h")
```

## Plot MPD vs Oxygen Concentration
```{r, eval=F}
lm_phylo_sesmpd_te <- lm(mpd.obs.z ~tidal_efficiency, data = phylo_sesmpd_env_phys)
summary(lm_phylo_sesmpd_te)

phylo_sesmpd_tidal_efficiency_plot <- ggplot(data = phylo_sesmpd_env, mapping = aes(x = tidal_efficiency, y = mpd.obs.z, color = Stratification, fill = Stratification)) + 
  geom_point(stat = 'identity',
    size = 5,
    alpha = 1) + 
  scale_color_viridis(alpha = 1, begin = 0.3, end = 0.75, discrete = T, option = "G") +
  scale_fill_viridis(alpha = 0.1, begin = 0.3, end = 0.75, discrete = T, option = "G") +
  theme_bw() +
  theme(text = element_text(size = 12),    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()) +
  theme(axis.line = element_line(color = "black")) +
  labs(x= "Tidal Efficiency", y= "sesMPD") +
  ylim(c(-6,2))
phylo_sesmpd_tidal_efficiency_plot <- phylo_sesmpd_tidal_efficiency_plot + geom_smooth(mapping = aes(x = tidal_efficiency, y = mpd.obs.z), method = lm, se = FALSE, inherit.aes = FALSE, color = 'black')
phylo_sesmpd_tidal_efficiency_plot
ggsave("phylo_sesmpd_tidal_efficiency_plot.png", phylo_sesmpd_tidal_efficiency_plot, width = 6, height = 4, units = "in")
```

## Plot MPD vs Tidal efficiency
```{r, eval=F}
lm_phylo_sesmpd_te <- lm(mpd.obs.z ~tidal_efficiency, data = phylo_sesmpd_env_phys)
summary(lm_phylo_sesmpd_te)

phylo_sesmpd_tidal_efficiency_plot <- ggplot(data = phylo_sesmpd_env, mapping = aes(x = tidal_efficiency, y = mpd.obs.z, color = Stratification, fill = Stratification)) + 
  geom_point(stat = 'identity',
    size = 5,
    alpha = 1) + 
  scale_color_viridis(alpha = 1, begin = 0.3, end = 0.75, discrete = T, option = "G") +
  scale_fill_viridis(alpha = 0.1, begin = 0.3, end = 0.75, discrete = T, option = "G") +
  theme_bw() +
  theme(text = element_text(size = 12),    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()) +
  theme(axis.line = element_line(color = "black")) +
  labs(x= "Tidal Efficiency", y= "sesMPD") +
  ylim(c(-6,2))
phylo_sesmpd_tidal_efficiency_plot <- phylo_sesmpd_tidal_efficiency_plot + geom_smooth(mapping = aes(x = tidal_efficiency, y = mpd.obs.z), method = lm, se = FALSE, inherit.aes = FALSE, color = 'black')
phylo_sesmpd_tidal_efficiency_plot
ggsave("phylo_sesmpd_tidal_efficiency_plot.png", phylo_sesmpd_tidal_efficiency_plot, width = 6, height = 4, units = "in")
```

## Regression of MNTD
```{r, eval=F}
#MNTD
man_phylo_sesmntd_env_chem <- manova(cbind(temperature_median, salinity_median, oxygen_median, pH_median) ~ mntd.obs.z, data = phylo_sesmntd_env)
summary.aov(man_phylo_sesmntd_env_chem)

phylo_sesmntd_env_chem_model <- glmulti("mntd.obs.z", c("temperature_median", "salinity_median", "oxygen_median", "pH_median"), intercept = FALSE, level = 1, data = phylo_sesmntd_env, method = "h")

man_phylo_sesmntd_env_phys <- manova(cbind(surface_area_m2, volume_m3_w_chemocline, distance_to_ocean_min_m, tidal_efficiency, depth) ~ mntd.obs.z, data = phylo_sesmntd_env)
summary.aov(man_phylo_sesmntd_env_phys)

phylo_sesmntd_env_phys_model <- glmulti("mntd.obs.z", c("surface_area_m2", "volume_m3_w_chemocline", "distance_to_ocean_min_m", "tidal_efficiency", "depth", "logArea"), intercept = FALSE, level = 1, data = phylo_sesmntd_env, method = "h")

#phylo_sesmntd_env_model <- glmulti("mntd.obs.z", c("surface_area_m2", "volume_m3_w_chemocline", "distance_to_ocean_min_m", "tidal_efficiency", "conductivity_median", "salinity_median", "oxygen_median", "pH_median"), intercept = FALSE, level = 1, data = phylo_sesmntd_env, method = "h")

phylo_mntd_env_model <- lm(mntd.obs.z ~ -1 + volume_m3_w_chemocline + distance_to_ocean_min_m + tidal_efficiency + salinity_median, data = phylo_sesmntd_env)
summary(phylo_mntd_env_model)
anova(phylo_mntd_env_model)
```

## Plot MNTD vs Oxygen Concentration
```{r, eval=F}
phylo_sesmntd_oxygen_plot <- ggplot(data = phylo_sesmntd_env, mapping = aes(x = oxygen_median, y = mntd.obs.z, color = Environment)) + 
  geom_point(stat = 'identity',
    size = 12,
    alpha = 1) + 
  scale_color_viridis(alpha = 1, begin = .3, end = .95, discrete = TRUE, option = "H") +
  theme_bw() +
  theme(text = element_text(size = 36),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()) +
  theme(axis.line = element_line(color = "black")) +
  labs(x= "Median Oxygen Concentration (mg/L)", y= "sesMNTD") +
  ylim(c(-7,1))
phylo_sesmntd_oxygen_plot <- phylo_sesmntd_oxygen_plot + geom_smooth(mapping = aes(x = oxygen_median, y = mntd.obs.z), method = lm, se = FALSE, inherit.aes = FALSE, color = 'black')
ggsave("phylo_sesmntd_oxygen_plot.png", phylo_sesmntd_oxygen_plot, width = 2, height = 2)
```

## Plot MNTD vs Tidal Efficiency
```{r, eval=F}
phylo_sesmntd_tidal_efficiency_plot <- ggplot(data = phylo_sesmntd_env, mapping = aes(x = tidal_efficiency, y = mntd.obs.z, color = Environment)) + 
  geom_point(stat = 'identity',
    size = 12,
    alpha = 1) + 
  scale_color_viridis(alpha = 1, begin = .3, end = .95, discrete = TRUE, option = "H") +
  theme_bw() +
  theme(text = element_text(size = 36),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()) +
  theme(axis.line = element_line(color = "black")) +
  labs(x= "Tidal Efficiency", y= "sesMNTD") +
  ylim(c(-7,1))
phylo_sesmntd_tidal_efficiency_plot <- phylo_sesmntd_tidal_efficiency_plot + geom_smooth(mapping = aes(x = tidal_efficiency, y = mntd.obs.z), method = lm, se = FALSE, inherit.aes = FALSE, color = 'black')
ggsave("phylo_sesmntd_tidal_efficiency_plot.png", phylo_sesmntd_tidal_efficiency_plot, width = 2, height = 2)
```

## Regression of PD
```{r, eval=F}
#PD
man_phylo_sespd_env_chem <- manova(cbind(temperature_median, salinity_median, oxygen_median, pH_median) ~ pd.obs.z, data = phylo_sespd_env)
summary.aov(man_phylo_sespd_env_chem)

phylo_sespd_env_chem_model <- glmulti("pd.obs.z", c("temperature_median", "salinity_median", "oxygen_median", "pH_median"), intercept = FALSE, level = 1, data = phylo_sespd_env, method = "h")

man_phylo_sespd_env_phys <- manova(cbind(surface_area_m2, volume_m3_w_chemocline, distance_to_ocean_min_m, tidal_efficiency, depth, logArea) ~ pd.obs.z, data = phylo_sespd_env)
summary.aov(man_phylo_sespd_env_phys)

phylo_sespd_env_phys_model <- glmulti("pd.obs.z", c("surface_area_m2", "volume_m3_w_chemocline", "distance_to_ocean_min_m", "tidal_efficiency", "depth", "logArea"), intercept = FALSE, level = 1, data = phylo_sespd_env, method = "h")

#phylo_sespd_env_model <- glmulti("pd.obs.z", c("surface_area_m2", "volume_m3_w_chemocline", "distance_to_ocean_min_m", "tidal_efficiency", "conductivity_median", "salinity_median", "oxygen_median", "pH_median"), intercept = FALSE, level = 1, data = phylo_sespd_env, method = "h")

phylo_sespd_env_model <- lm(pd.obs.z ~ -1 + volume_m3_w_chemocline + distance_to_ocean_min_m + tidal_efficiency + salinity_median, data = phylo_sespd_env)
summary(phylo_pd_env_model)
anova(phylo_pd_env_model)
```

## Plot PD vs Oxygen Concentration
```{r, eval=F}
phylo_sespd_env_plot <- ggplot(data = phylo_sespd_env, mapping = aes(x = env_variable, y = pd.obs.z, color = Environment, shape = Environment, label = X)) + 
  geom_point(stat = 'identity',
    size = 12,
    alpha = 1) + 
  geom_text_repel(min.segment.length = 2, show.legend = FALSE) +
  scale_color_viridis(alpha = 1, begin = .3, end = .95, discrete = TRUE, option = "H") +
  theme_bw() +
  theme(text = element_text(size = 36),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()) +
  theme(axis.line = element_line(color = "black")) +
  labs(x= "Env Variable", y= "sesFPD")
phylo_sespd_env_plot
ggsave("phylo_sespd_env_plot.png", phylo_sespd_env_plot, width = 2, height = 2)
```

## Plot PD vs Tidal Efficiency
```{r, eval=F}
phylo_sespd_env_plot <- ggplot(data = phylo_sespd_env, mapping = aes(x = env_variable, y = pd.obs.z, color = Environment, shape = Environment, label = X)) + 
  geom_point(stat = 'identity',
    size = 12,
    alpha = 1) + 
  geom_text_repel(min.segment.length = 2, show.legend = FALSE) +
  scale_color_viridis(alpha = 1, begin = .3, end = .95, discrete = TRUE, option = "H") +
  theme_bw() +
  theme(text = element_text(size = 36),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()) +
  theme(axis.line = element_line(color = "black")) +
  labs(x= "Env Variable", y= "sesFPD")
phylo_sespd_env_plot
ggsave("phylo_sespd_env_plot.png", phylo_sespd_env_plot, width = 2, height = 2)
```

## Plot z-scores and environmental variables
```{r, eval=F}
traits_phylo_ses_tidal_plot <- ggplot(data =  traits_phylo_ses_env, mapping = aes(x = tidal_efficiency, y = obs.z, color = Stratification, fill = Stratification)) + 
  geom_point(stat = 'identity',
    size = 5,
    alpha = 1) + 
  scale_color_viridis(alpha = 1, begin = 0.3, end = 0.75, discrete = T, option = "G") +
  scale_fill_viridis(alpha = 0.5, begin = 0.3, end = 0.75, discrete = T, option = "G") +
  theme_bw() +
  theme(text = element_text(size = 24),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black")) +
  labs(x= "Tidal Efficiency", y= "z-score") +
  ylim(c(-10,10))
traits_phylo_ses_tidal_plot <- traits_phylo_ses_tidal_plot + geom_smooth(mapping = aes(x = tidal_efficiency, y = obs.z), method = lm, se = FALSE, inherit.aes = FALSE, color = 'black')
traits_phylo_ses_tidal_plot <- traits_phylo_ses_tidal_plot + facet_wrap(ncol=3)
traits_phylo_ses_tidal_plot
ggsave("traits_phylo_ses_tidal_plot.png", traits_phylo_ses_tidal_plot, width = 2, height = 2)


traits_phylo_ses_oxygen_plot <- ggplot(data = traits_phylo_FD_all_env[-c(65:72,121:128,137:144,153:160),], mapping = aes(x = oxygen_median, y = obs.z, color = Environment)) + 
  geom_point(stat = 'identity',
    size = 8,
    alpha = 1) + 
  scale_color_viridis(alpha = 1, end = .95, discrete = TRUE, option = "H") +
  theme_bw() +
  theme(text = element_text(size = 24),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()) +
  theme(axis.line = element_line(color = "black")) +
  labs(x= "Median Oxygen Concentration (mg/L)", y= "z-score") +
  ylim(c(-10,10))
traits_phylo_ses_oxygen_plot <- traits_phylo_ses_oxygen_plot + geom_smooth(mapping = aes(x = oxygen_median, y = obs.z), method = lm, se = FALSE, inherit.aes = FALSE, color = 'black')
traits_phylo_ses_oxygen_plot <- traits_phylo_ses_oxygen_plot + facet_wrap(vars(Indice), ncol=2)
traits_phylo_ses_oxygen_plot
ggsave("traits_phylo_ses_oxygen_plot.png", traits_phylo_ses_oxygen_plot, width = 2, height = 2)
```

## Beta Diversity of phylogenetic relatedness
```{r, eval=F}
# Do the following to order lakes by the circulation pattern, then delete env data
####https://pedrohbraga.github.io/CommunityPhylogenetics-Workshop/CommunityPhylogenetics-Workshop.html#between-assemblage-phylogenetic-structure####
presabs_env <- merge(pres_abs_by_lake, env_byLake, by = 'X')
presabs_env <- presabs_env[order(presabs_env$Environment),]
row.names(presabs_env) <- presabs_env$X
presabs_env_ordered <- presabs_env[,-c(1, 1692:1722)]

phylo_betap_jac <- phylo.beta.pair(presabs_env_ordered[-23,], phylo_tree, index.family = "jaccard")

# Turnover matrix:
phylo.jac.turn <- phylo_betap_jac$phylo.beta.jtu %>% 
  as.matrix() %>% melt() %>% 
  ggplot() + geom_tile(aes(x = Var1, y = Var2, fill = value)) + # create the heatmap
  xlab("Sites") + ylab("Sites") + labs(fill = "Turnover") + # edit axis and legend titles
  scale_fill_viridis_c(option = "H", limits = range(0,1)) +
  theme(axis.text.x = element_text(angle = 90)) # rotates x axis labels

# Nestedness matrix:
phylo.jac.nest <- phylo_betap_jac$phylo.beta.jne %>% 
  as.matrix() %>% melt() %>% 
  ggplot() + geom_tile(aes(x = Var1, y = Var2, fill = value)) + # create the heatmap
  xlab("Sites") + ylab("Sites") + labs(fill = "Nestedness") + # edit axis and legend titles
    scale_fill_viridis_c(option = "H", limits = range(0,1)) +
  theme(axis.text.x = element_text(angle = 90)) # rotates x axis labels

# Beta Diversity matrix:
phylo.jac <- phylo_betap_jac$phylo.beta.jac %>% 
  as.matrix() %>% melt() %>% 
  ggplot() + geom_tile(aes(x = Var1, y = Var2, fill = value)) + # create the heatmap
  xlab("Sites") + ylab("Sites") + labs(fill = "Beta Diversity") + # edit axis and legend titles
    scale_fill_viridis_c(option = "H", limits = range(0,1)) +
  theme(axis.text.x = element_text(angle = 90)) # rotates x axis labels
phylo.jac

# plot both heatmaps next to each other
phylo_beta_div_plot <- gridExtra::grid.arrange(phylo.jac.turn, phylo.jac.nest, ncol = 2)
ggsave("phylo_beta_div_plot.png", phylo_beta_div_plot, width = 6, height = 4.5)
```
